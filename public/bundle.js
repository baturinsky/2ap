var app=function(t){"use strict";function e(t,e,i,s){var a,n=arguments.length,r=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,s);else for(var o=t.length-1;o>=0;o--)(a=t[o])&&(r=(n<3?a(r):n>3?a(e,i,r):a(e,i))||r);return n>3&&r&&Object.defineProperty(e,i,r),r}function i(t,e,i,s){return new(i||(i=Promise))(function(a,n){function r(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){t.done?a(t.value):new i(function(e){e(t.value)}).then(r,o)}l((s=s.apply(t,e||[])).next())})}function s(t,e){let i=function(t,e){let i=Number.MAX_VALUE,s=-1;for(let a=0;a<t.length;a++){let n=e(t[a]);i>n&&(i=n,s=a)}if(s>=0)return{ind:s,item:t[s],val:i}}(t,t=>-e(t));if(i)return i.val=-i.val,i}function a(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,i}function n(t,e){const i=a(...t),s=i.getContext("2d");return s.lineWidth=1,s.strokeStyle="#000",e(s),i}function r(t,e){return Math.floor(t/e)}function o(t,e,i){return{get(){const t=i.value.bind(this);return Object.defineProperty(this,e,{value:t}),t}}}function l(t){if(!t)return null;let e=t.split('"');for(let t=1;t<e.length;t+=2)e[t]=e[t].replace(/\n/g,"\\n");return JSON.parse(e.join('"'))}function h(t,e,i=1){return[t[0]+e[0]*i,t[1]+e[1]*i]}function c(t,e){return[t[0]-e[0],t[1]-e[1]]}function u(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function d(t,e=1){let i=u(t)||1;return[t[0]/i*e,t[1]/i*e]}function m(t,e){return u([t[0]-e[0],t[1]-e[1]])}function p(t,e){return t[0]*e[0]+t[1]*e[1]}function g(t,e){return t[0]*e[1]-t[1]*e[0]}function f(t,e){return[t[0]*e,t[1]*e]}function v(t,e,i){return[t[0]*(1-i)+i*e[0],t[1]*(1-i)+i*e[1]]}function y(t,e,i,s){var a=function(n,r,o,l){if(!(r>=o)){for(var h=Math.round((n-.5)*r),c=Math.ceil((n+.5)*o-.5),u=h;u<=c;u++){var d=t+l.xx*u+l.xy*n,m=e+l.yx*u+l.yy*n;if(i(d,m))u>=n*r&&u<=n*o&&s(d,m);else if(u>=(n-.5)*r&&u-.5<=n*o&&s(d,m),a(n+1,r,(u-.5)/n,l),(r=(u+.5)/n)>=o)return}a(n+1,r,o,l)}},n=[{xx:1,xy:0,yx:0,yy:1},{xx:1,xy:0,yx:0,yy:-1},{xx:-1,xy:0,yx:0,yy:1},{xx:-1,xy:0,yx:0,yy:-1},{xx:0,xy:1,yx:1,yy:0},{xx:0,xy:1,yx:-1,yy:0},{xx:0,xy:-1,yx:1,yy:0},{xx:0,xy:-1,yx:-1,yy:0}];s(t,e);for(var r=0;r<8;r++)a(1,0,1,n[r])}class S{constructor(t,e,i,s){this.terrain=t,this.cid=e,this.obstacle=i,this.unit=s,this.rfov=new Set,this.xfov=new Set,this.dfov=new Set,this.povs=[],this.peeked=[]}calculatePovAnCover(){this.obstacle||(this.cover=this.terrain.obstacles(this.cid),this.calculatePovs())}calculateFov(){if(this.opaque)return;let t=this.terrain,[e,i]=this.at,s=new Set;y(e,i,(e,i)=>!t.cellAt(e,i).opaque,(e,i)=>{s.add(t.cid(e,i))}),this.rfov=s}calculateXFov(){let t=new Set;for(let e of this.povs)for(let i of e.rfov){let e=this.terrain.cells[i];for(let i of e.peeked)t.add(i.cid)}this.xfov=t}calculateDFov(){let t=new Set;for(let e of this.povs)for(let i of e.rfov)t.add(i);this.dfov=t}get at(){return this.terrain.fromCid(this.cid)}dist(t){return m(this.at,t.at)}seal(){this.obstacle=2,delete this.unit,this.goody=0}get opaque(){return 2==this.obstacle}get passable(){return this.obstacle<2&&!this.hole}get standable(){return 0==this.obstacle&&!this.hole&&!this.unit}calculatePovs(){this.povs=[];let t=this.terrain,e=this.cid;this.povs.push(this);for(let i=0;i<8;i+=2){let s=e+t.dir8Deltas[i];if(!t.cells[s].obstacle)continue;let a=[e+t.dir8Deltas[(i+6)%8],e+t.dir8Deltas[(i+7)%8]],n=[e+t.dir8Deltas[(i+2)%8],e+t.dir8Deltas[(i+1)%8]];for(let e of[a,n]){t.cells[e[0]].standable&&t.cells[e[1]].obstacle<=1&&this.povs.push(t.cells[e[0]])}}for(let t of this.povs)t.peeked.push(this)}}class b{constructor(t,e){this.terrain=t,this.faction=e,this.fov=new Set}serialize(){return{units:this.units.map(t=>t.serialize())}}calculate(){this.strength=[],this.weakness=[],this.distance=[];let t=this.terrain;this.fov.clear();for(let t of this.units)for(let e of t.cell.xfov)this.fov.add(e);let e=this.terrain.teams[1-this.faction];for(let i of this.fov){let s=this.terrain.cells[i];for(let a of e.units){let e=a.cell,n=(4-t.cover(s,e))%5;this.strength[i]>n||(this.strength[i]=n);let r=(4-t.cover(e,s))%5;if(this.weakness[i]>r||(this.weakness[i]=r),n>0||r>0){let t=s.dist(e);this.distance[i]<=t||(this.distance[i]=t)}}}}think(){return i(this,void 0,void 0,function*(){this.terrain.aiTurn=!0,this.calculate();for(let t of this.terrain.units)t.team==this&&t.alive&&(yield t.think());this.terrain.aiTurn=!1})}endTurn(){}beginTurn(){for(let t of this.units)t.ap=2;this.terrain.activeTeam=this}get units(){return this.terrain.units.filter(t=>t.team==this)}get enemy(){return this.terrain.teams[1-this.faction]}get name(){return["RED","BLUE"][this.faction]}get color(){return["RED","BLUE"][this.faction]}}b.BLUE=0,b.RED=1;class C{constructor(t,e){this.cell=t,this.speed=5,this.maxHP=10,this.hp=this.maxHP,this.ap=2,this.exhaustion=0,this.stress=0,this.focus=[0,0],this.velocity=[0,0],this.armor=0,this.sight=20,this.def=0,this.aggression=0,this.name="dude",this.symbol="d",this.symbol=e.symbol.toLowerCase(),t.unit=this;let i=t.terrain;this.terrain.units.push(this);let s=i.campaign.units[this.symbol];Object.assign(this,s),this.hp=this.maxHP,console.assert(s),this.team=i.teams[e.symbol.toUpperCase()==e.symbol?b.BLUE:b.RED];for(let t of C.saveFields)t in e&&(this[t]=e[t]);this.gun=this.terrain.campaign.guns[s.gun]}get terrain(){return this.cell.terrain}get cid(){return this.cell.cid}serialize(){return{symbol:this.symbol,hp:this.hp,ap:this.ap,cid:this.cid,exhaustion:this.exhaustion,stress:this.stress,focus:this.focus,velocity:this.velocity}}get blue(){return this.team==this.terrain.we}pathTo(t){let e=t.cid,i=[e];for(;!((e=this.dists[e][1])<0);)i.push(e);return i.reverse().map(t=>this.terrain.cells[t])}get strokeColor(){return this.blue?"#00a":"#a00"}get x(){return this.cid%this.terrain.w}get y(){return r(this.cid,this.terrain.w)}reachable(t){return this.apCost(t)<=this.ap}calculateDists(){this.dists=this.terrain.calcDists(this.cid)}calculate(){this.calculateDists()}cover(t){return this.terrain.cover(this.cell,t)}get at(){return this.terrain.fromCid(this.cid)}apCost(t){if(!this.dists)return Number.MAX_VALUE;let e=this.dists[t.cid][0];return Math.ceil(e/this.speed)}canShoot(){return this.ap>0}perpendicularVelocity(t){if(!this.moving)return 0;return g(d(c(t,this.at)),this.velocity)}velocityAccuracyBonus(t){return-Math.round(4*Math.abs(this.perpendicularVelocity(t)))}velocityDefenceBonus(t){return Math.round(4*Math.abs(this.perpendicularVelocity(t)))}focusAccuracyBonus(t){if(!this.focused)return 0;let e=(i=c(t,this.at),s=this.focus,Math.atan2(g(i,s),p(i,s)));var i,s;let a=1-4*Math.abs(e)/Math.PI;return a<0&&(a/=2),Math.round(a*u(this.focus))}focusDefenceBonus(t){return this.focusAccuracyBonus(t)}hitChance(t,e,i=!1,s){if(e||(e=t.unit),e==this)return 0;let a=i?this.cell.dfov:this.cell.xfov,n=t.at;if(!a.has(t.cid))return 0;let r=this.cover(t||e.cell);return-1==r?0:(s||(s={}),s.accuracy=this.gun.accuracy,s.cover=25*-r,s.dodge=-e.def,s.distance=-this.gun.accuracyPenalty(this.dist(e)),s.ownVelocity=this.velocityAccuracyBonus(n),s.targetVelocity=-e.velocityDefenceBonus(this.at),s.ownFocus=this.focusAccuracyBonus(n),s.targetFocus=-e.focusDefenceBonus(this.at),s.cover<s.targetVelocity?s.targetVelocity=0:s.cover=0,console.log(JSON.stringify(s)),Math.round(Object.values(s).reduce((t,e)=>t+e)))}die(){this.terrain.units=this.terrain.units.filter(t=>t.hp>0),delete this.cell.unit,0==this.team.units.length&&this.terrain.declareVictory(this.team.enemy)}takeDamage(t){this.hp=Math.max(0,this.hp-t),this.hp<=0&&this.die(),this.onChange()}onChange(){this.terrain.animate({char:this})}shoot(t){return i(this,void 0,void 0,function*(){if(!t)return!1;let e=t.unit;if(!e)return!1;let i=this.hitChance(t);if(0==i)return!1;let s=this.terrain.rni()%100<i;this.ap=0;let a=0;s&&(a=this.gun.damageRoll(this,e.cell,this.terrain.rnf)),yield this.animateShoot(e.cid,a),e.takeDamage(a),e.hp<=0&&this.team.calculate();let n=d(c(t.at,this.at));return this.focusAccuracyBonus(t.at),this.focus=f(n,Math.max(this.gun.maxFocus,10+this.focusAccuracyBonus(t.at))),this.velocity=[0,0],!0})}teleport(t){if(this.cell){if(this.cell==t)return;delete this.cell.unit}t.unit=this,this.cell=t,this.calculate()}calculateReactionFire(t){let e=this.team.enemy.units,i=[];for(let a of e){if(0==a.ap)continue;let e=s(t,t=>!t.unit&&a.averageDamage(t,this,!0));e&&e.val>=1&&i.push({moment:e.ind,enemy:a})}return i=i.sort((t,e)=>t.moment>e.moment?1:-1)}calculateVelocity(t){let e=c(t[t.length-1].at,t[0].at);return i=d(e,this.speed),[Math.round(i[0]),Math.round(i[1])];var i}move(t){return i(this,void 0,void 0,function*(){if(t==this.cell||!t)return!1;this.ap-=this.apCost(t);let e=this.pathTo(t);this.velocity=this.calculateVelocity(e),this.focus=d(this.velocity,10);let i=this.team.enemy.units,a=[];for(let t of i){if(0==t.ap)continue;let i=s(e,e=>!e.unit&&t.averageDamage(e,this,!0));i&&i.val>=1&&a.push({moment:i.ind,enemy:t})}a=a.sort((t,e)=>t.moment>e.moment?1:-1);for(let t of a){let i=e[t.moment];if(yield this.animateWalk(this.pathTo(i)),this.teleport(i),yield t.enemy.shoot(i),!this.alive)return!0}return yield this.animateWalk(this.pathTo(t)),this.teleport(t),this.cell.goody&&(this.hp=this.maxHP,this.cell.goody=0),!0})}animateWalk(t){return i(this,void 0,void 0,function*(){t.length<=1||(yield this.terrain.animate({anim:"walk",char:this,path:t}))})}animateShoot(t,e){return i(this,void 0,void 0,function*(){yield this.terrain.animate({anim:"shoot",from:this.cid,to:t,damage:e})})}canDamage(t){return t&&this.team!=t.team&&this.cell.xfov.has(t.cid)&&this.canShoot()}bestPosition(){let t=this.team;this.calculate();let e,i=-100;for(let s in this.dists){let a=this.dists[s][0];if(a>this.speed*this.ap)continue;let n=t.strength[s]-t.weakness[s]-.5*r(a,this.speed)-.001*a;(n+=t.distance[s]*this.aggression)>i&&(i=n,e=Number(s))}return this.terrain.cells[e]}averageDamage(t,e,i=!1){return this.hitChance(t,e,i)*this.gun.averageDamage(this,t)/100}bestTarget(){let t=-100,e=null;for(let i of this.terrain.units){if(i.team==this.team||i.hp<=0)continue;let s=this.averageDamage(i.cell);s>t&&(t=s,e=i.cell)}return e}think(){return i(this,void 0,void 0,function*(){yield this.move(this.bestPosition()),this.ap>0&&(yield this.shoot(this.bestTarget()))})}dist(t){return m(this.at,t.at)}get alive(){return this.hp>0}friendly(t){return t&&this.team==t.team}get moving(){return u(this.velocity)>0}get focused(){return u(this.focus)>0}}C.EYE=-1,C.GUNNER=1,C.ASSAULT=2,C.SNIPER=3,C.RECON=4,C.MEDIC=5,C.HEAVY=6,C.COMMANDER=7,C.saveFields="hp ap exhaustion stress focus velocity".split(" ");class P{constructor(t){this.damageOptimalRange=[1,20],this.damage=[4,5],this.damagePenaltyPerCell=100,this.accuracyPenaltyMax=20,this.accuracy=60,this.accuracyOptimalRange=[1,1],this.accuracyPenaltyPerCell=1,this.damagePenaltyMax=2,this.breach=0,this.maxFocus=30,this.name="Gun",t&&Object.assign(this,t)}damagePenalty(t){let e=0;return t<this.damageOptimalRange[0]&&(e=this.damageOptimalRange[0]-t),t>this.damageOptimalRange[1]&&(e=t-this.damageOptimalRange[1]),Math.floor(Math.min(this.damagePenaltyMax,this.damagePenaltyPerCell*e))}accuracyPenalty(t){let e=0;return t<this.accuracyOptimalRange[0]&&(e=this.accuracyOptimalRange[0]-t),t>this.accuracyOptimalRange[1]&&(e=t-this.accuracyOptimalRange[1]),Math.floor(Math.min(this.accuracyPenaltyMax,this.accuracyPenaltyPerCell*e))}averageDamage(t,e,i){i||(i=e.unit);let s=.5*(this.damage[1]+this.damage[0]);return i&&(s-=Math.max(0,e.unit.armor-this.breach)),s-=this.damagePenalty(t.dist(e)),Math.max(0,Math.round(10*s)/10)}damageRoll(t,e,i){let s=i()*(this.damage[1]-this.damage[0])+this.damage[0];return e.unit&&(s-=Math.max(0,e.unit.armor-this.breach)),s-=this.damagePenalty(t.dist(e)),Math.max(0,Math.round(s))}}class x{constructor(t,e,i,s){var a;this.campaign=t,this.stage=e,this.animate=s,this.aiTurn=!1,this.rni=(a=1,(a%=2147483647)<=0&&(a+=2147483646),()=>a=16807*a%2147483647),this.rnf=(()=>this.rni()%1e9/1e9);for(let e in t.guns)t.guns[e]=new P(t.guns[e]);this.init(this.stage.terrain),i&&this.loadState(i)}serialize(){return{teams:this.teams.map(t=>t.serialize()),activeTeam:this.activeTeam.faction}}init(t){this.terrainString=t;let e=t.split("\n").map(t=>t.trim()).filter(t=>t.length>0);this.h=e.length,this.w=Math.max(...e.map(t=>t.length)),this.cells=[],this.units=[],this.teams=[],delete this.victor;for(let t=0;t<2;t++){let e=new b(this,t);this.teams[t]=e}for(let t=0;t<this.h;t++){let i=e[t];for(let e=0;e<this.w;e++){let s=e+t*this.w,a=i[e]||" ",n=new S(this,s,["+","#"].indexOf(a)+1);this.campaign.units[a.toLowerCase()]&&new C(n,{symbol:a,cid:s}),"*"==a&&(n.goody=1),"~"==a&&(n.hole=!0),this.cells[s]=n}}for(let t=0;t<this.w;t++)this.seal(t,0),this.seal(t,this.h-1);for(let t=0;t<this.h;t++)this.seal(0,t),this.seal(this.w-1,t);this.dir8Deltas=x.dirs8.map(t=>t[0]+t[1]*this.w);for(let t of this.cells)t.obstacle||t.calculatePovAnCover();console.log(this.w),console.log(this.h),console.time("FOV");for(let t of this.cells)t.obstacle||(t.calculatePovAnCover(),t.calculateFov());console.timeEnd("FOV");for(let t of this.cells)t.obstacle||(t.calculateXFov(),t.calculateDFov());this.activeTeam=this.teams[0],console.log(this)}seal(t,e){this.cells[this.cid(t,e)].seal()}loadState(t){t&&t.teams&&(this.units=[],this.cells.forEach(t=>delete t.unit),this.teams=t.teams.map((t,e)=>{let i=new b(this,e);for(let e of t.units){new C(this.cells[e.cid],e).team=i}return i}),this.activeTeam=this.teams[t.activeTeam])}calcDists(t){let e=this.cells.map(t=>[Number.MAX_VALUE,-1]);e[t]=[0,-1];let i=[t],s=this.cells[t].unit;for(;i.length>0;){let t=i.shift(),a=e[t][0],n=this.cells[t];for(let r=0;r<8;r++){let o=r%2,l=this.dir8Deltas[r]+t,h=this.cells[l];if(!h.passable||h.unit&&!h.unit.friendly(s))continue;if(o&&(this.cells[t+this.dir8Deltas[(r+1)%8]].obstacle||this.cells[t+this.dir8Deltas[(r+7)%8]].obstacle))continue;let c=h.obstacle+n.obstacle+(n.unit?1:0)+(h.unit?1:0);if(c>1&&o&&c>0)continue;let u=c+(o?1.414:1);e[l][0]>a+u&&(e[l]=[a+u,t],i.push(l))}}for(let t=0;t<e.length;t++)this.cells[t].standable||(e[t][0]=Number.MAX_VALUE);return e}safeCid(t,e){if(t>=0&&e>=0&&t<this.w&&e<this.h)return this.cid(t,e)}cid(t,e){return t+e*this.w}cellAt(t,e){return this.cells[this.cid(t,e)]}fromCid(t){return[t%this.w,r(t,this.w)]}calculateFov(t){let[e,i]=this.fromCid(t),s=new Set;return y(e,i,(t,e)=>!this.cellAt(t,e).opaque,(t,e)=>{for(let i of this.cells[this.cid(t,e)].peeked)s.add(i.cid)}),s}calculateDirectFov(t){let[e,i]=this.fromCid(t),s=new Set;return y(e,i,(t,e)=>!this.cellAt(t,e).opaque,(t,e)=>{s.add(this.cid(t,e))}),s}obstacles(t){let e=[];for(let i=0;i<8;i+=2){let s=t+this.dir8Deltas[i];e.push(this.cells[s].obstacle)}return e}cover(t,e){if(!t.xfov.has(e.cid))return-1;let i=2;for(let s of t.povs){let t=0,a=c(e.at,s.at);for(let i=0;i<4;i++){let s=e.cover[i];s<=t||p(x.dirs8[2*i],a)<-.001&&(t=s)}t<i&&(i=t)}return i}declareVictory(t){this.victor=t}get we(){return this.teams[b.BLUE]}endSideTurn(){this.activeTeam.endTurn(),this.teams[(this.activeTeam.faction+1)%this.teams.length].beginTurn()}}x.dirs8=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];class w{constructor(t,e,i,s,a=[0,0]){this.text=t,this.color=e,this.lifeTime=i,this.at=s,this.vel=a,this.time=0}update(t){return this.time+=t,this.at=h(this.at,this.vel,t),this.time<this.lifeTime}render(t){t.save(),t.fillStyle=this.color,t.shadowColor="black",t.shadowBlur=1,t.shadowOffsetX=1,t.shadowOffsetY=1,t.font='12pt "Courier"',t.textAlign="center";let e=0,i=0;for(let s of this.text.split("|"))t.fillText(s.trim().substr(0,Math.floor(70*this.time)-i),this.at[0],this.at[1]+e),i+=s.length,e+=20;t.restore()}}let k=0;const T=4;class A{constructor(t,e){this.unit=t,this.at=e.cidToPoint(t.cid)}}class z{constructor(t){this.game=t,this.canvasCacheOutdated=!1,this.anim=[],this.animQueue=[],this.dolls=[],this.tileSize=32,this.screenPos=[0,0],this.dollCache={},this.initSprites()}get canvas(){return this.game.canvas}synch(){this.dolls=this.terrain.units.map(t=>new A(t,this)),this.updateCanvasCache()}get terrain(){return this.game.terrain}resize(){this.canvas&&(this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.terrain&&(this.screenPos=[.5*(this.width-this.terrain.w*this.tileSize),.5*(this.height-this.terrain.h*this.tileSize)]),this.canvas.getContext("2d").imageSmoothingEnabled=!1)}update(t){if(this.lookingAt&&m(this.lookingAt,this.screenPos)>1){let e=m(this.lookingAt,this.screenPos);this.screenPos=v(this.screenPos,this.lookingAt,Math.min(1,t*Math.max(e/100,5)))}else{delete this.lookingAt;let e=this.anim;this.anim=[],e=e.filter(e=>e.update(t)),this.anim=this.anim.concat(e),this.animQueue.length>0&&!this.animQueue[0].update(t)&&this.animQueue.shift(),0==this.animQueue.length&&this.blockingAnimationEnd&&(this.blockingAnimationEnd(),delete this.blockingAnimationEnd)}this.dolls=this.dolls.filter(t=>t.unit.alive)}render(t){if(!t)return;t.clearRect(0,0,this.width,this.height);let e=this.terrain;t.save(),t.translate(...this.screenPos),this.canvasCache&&!this.canvasCacheOutdated||this.updateCanvasCache(),t.clearRect(0,0,e.w*this.tileSize,e.h*this.tileSize),t.drawImage(this.canvasCache,0,0);for(let e of this.dolls)this.renderDoll(t,e);for(let e of this.anim)e.render&&e.render(t);return this.animQueue.length>0&&this.animQueue[0].render&&this.animQueue[0].render(t),this.busy||this.renderPath(t,this.game.hovered),t.restore(),this.animQueue.length>0}renderPath(t,e){let i=this.game.chosen;if(!(i&&e&&i.dists&&i.dists[e.cid]&&-1!=i.dists[e.cid][1]))return;if(!i.reachable(e))return;let s=this.cidToCenterPoint(e.cid);t.beginPath(),i.reachable(e)?t.arc(s[0],s[1],this.tileSize/4,0,2*Math.PI):(t.moveTo(s[0]-this.tileSize/4,s[1]-this.tileSize/4),t.lineTo(s[0]+this.tileSize/4,s[1]+this.tileSize/4),t.stroke(),t.beginPath(),t.moveTo(s[0]-this.tileSize/4,s[1]+this.tileSize/4),t.lineTo(s[0]+this.tileSize/4,s[1]-this.tileSize/4)),t.stroke();let a=i.pathTo(e);t.beginPath(),t.moveTo(...this.cidToCenterPoint(a[0].cid));for(let e of a)t.lineTo(...this.cidToCenterPoint(e.cid));t.stroke()}renderThreats(t,e){let i=this.terrain,s=e.cid;i.teams[b.RED].strength&&(t.strokeStyle="#800",t.lineWidth=4==i.teams[b.RED].strength[s]?3:1,t.beginPath(),t.moveTo(3.5,3.5),t.lineTo(3.5,3.5+3*i.teams[b.RED].strength[s]),t.stroke(),t.strokeStyle="#008",t.lineWidth=4==i.teams[b.RED].weakness[s]?3:1,t.beginPath(),t.moveTo(3.5,3.5),t.lineTo(3.5+3*i.teams[b.RED].weakness[s],3.5),t.stroke())}renderCell(t,e){let i=this.cidToPoint(e.cid),s=[,this.lowTile,this.highTile][e.obstacle];e.hole&&(s=this.waterTile),s&&t.drawImage(s,i[0],i[1]),e.goody&&(t.translate(...i),t.fillStyle="#080",t.fillRect(.35*this.tileSize,0,.3*this.tileSize,this.tileSize),t.fillRect(0,.35*this.tileSize,this.tileSize,.3*this.tileSize),t.translate(...f(i,-1)))}renderCellUI(t,e){let i=this.cidToPoint(e.cid),s=this.game;if(t.strokeStyle="#000",t.lineWidth=2,s.hovered&&!s.hovered.opaque){let a=s.hovered.xfov.has(e.cid);s.hovered.rfov.has(e.cid)||(t.fillStyle=`rgba(${a?"50,50,0,0.04":"0,0,50,0.1"})`,t.fillRect(i[0],i[1],this.tileSize,this.tileSize))}if(s.chosen&&s.chosen.dists&&!this.busy){let a=s.chosen.apCost(e);if(a>0&&a<=s.chosen.ap){let e=[,this.ap1Sprite,this.ap2Sprite][Math.floor(a)];e&&t.drawImage(e,i[0],i[1])}}e.povs&&e.peeked.includes(this.game.hovered)&&(t.strokeStyle="rgba(0,0,0,0.5)",t.lineWidth=.5,t.beginPath(),t.arc(i[0]+this.tileSize/2,i[1]+this.tileSize/2,this.tileSize/4,0,2*Math.PI),t.stroke())}renderDoll(t,e){t.save(),t.translate(...e.at),this.useDollCache(t,e),e.unit==this.game.chosen?this.outline(t,e,Math.sin((new Date).getTime()/100)+1):e.unit==this.game.hoveredChar&&this.outline(t,e,1.5),t.restore()}outline(t,e,i=2){t.save(),t.strokeStyle=e.unit.strokeColor,t.lineWidth=i,t.beginPath(),t.arc(this.tileSize/2,this.tileSize/2,.4*this.tileSize,0,2*Math.PI),t.stroke(),t.restore()}useDollCache(t,e){let i=e.unit,s=["cid","hp","ap","kind","faction","focus","velocity"].map(t=>i[t]);s.push(this.dollTint(e));let a=JSON.stringify(s);a in this.dollCache||(this.dollCache[a]=n([2*this.tileSize,2*this.tileSize],t=>this.renderDollBody(t,e,this.dollTint(e)))),t.drawImage(this.dollCache[a],-.5*this.tileSize,-.5*this.tileSize)}dollTint(t){if(this.busy||this.terrain.aiTurn)return 0;let e=t.unit,i=0,s=this.game.hovered;if(s&&!s.opaque&&s.xfov){i=s.xfov.has(e.cid)||e.team==this.game.lastSelectedFaction?(0==this.terrain.cover(e.cell,s)?1:0)+(0==this.terrain.cover(s,e.cell)?2:0):4}return this.game.hovered||(i=0),i}renderDollBody(t,e,i){let s=e.unit;if(t.fillStyle=["#fff","#fba","#cfa","#ffa","#ccc"][i],t.strokeStyle=s.strokeColor,t.scale(this.tileSize,this.tileSize),t.translate(.5,.5),t.shadowColor="#444",t.shadowOffsetX=1,t.shadowOffsetY=1,t.shadowBlur=4,t.beginPath(),t.arc(.5,.5,.4,0,2*Math.PI),t.fill(),t.shadowColor="rgba(0,0,0,0)",t.lineWidth=.1,s.ap>0&&(t.fillStyle=e.unit.strokeColor,t.beginPath(),t.moveTo(.2,.3),t.lineTo(.3,.2),t.stroke(),s.ap>1&&(t.beginPath(),t.moveTo(.8,.3),t.lineTo(.7,.2),t.stroke())),t.beginPath(),t.fillStyle=s.strokeColor,t.textAlign="center",t.font="bold 0.5pt Courier",t.fillText(s.symbol.toUpperCase(),.5,.66),t.stroke(),t.save(),t.lineWidth=.05,t.transform(-1,0,0,1,1,0),t.setLineDash([6/s.maxHP-.05,.05]),t.beginPath(),t.arc(.5,.5,.35,0,Math.PI*s.hp/s.maxHP),t.stroke(),t.restore(),s.moving){t.save(),t.translate(.5,.5);let e=Math.atan2(s.velocity[1],s.velocity[0]);t.rotate(e),t.lineWidth=.01+.01*u(s.velocity),t.moveTo(-.6,-.15),t.lineTo(-.45,0),t.lineTo(-.6,.15),t.stroke(),t.restore()}if(s.focused){t.save(),t.translate(.5,.5);let e=Math.atan2(s.focus[1],s.focus[0]);t.rotate(e),t.lineWidth=.003*u(s.focus),t.moveTo(.45,-.15),t.lineTo(.6,0),t.lineTo(.45,.15),t.stroke(),t.restore()}}cidToPoint(t){return this.terrain.fromCid(t).map(t=>t*this.tileSize)}cidToCenterPoint(t){return f(h(this.terrain.fromCid(t),[.5,.5]),this.tileSize)}cidToCenterScreen(t){return h(this.cidToCenterPoint(t),this.screenPos)}cidFromPoint(t,e){return this.terrain.safeCid(r(t,this.tileSize),r(e,this.tileSize))}cellAtScreenPos(t,e){return this.terrain.cells[this.cidFromPoint(...c([t,e],this.screenPos))]}get animationSpeed(){return this.terrain.aiTurn,.5}updateCanvasCache(){this.canvasCache||(this.canvasCache=a(this.terrain.w*this.tileSize,this.terrain.h*this.tileSize)),this.canvasTerrain||(this.canvasTerrain=a(this.terrain.w*this.tileSize,this.terrain.h*this.tileSize));let t=this.canvasTerrain.getContext("2d");t.clearRect(0,0,this.terrain.w*this.tileSize,this.terrain.h*this.tileSize);for(let e=0;e<this.terrain.cells.length;e++){let i=this.terrain.cells[e];this.renderCell(t,i)}let e=this.canvasCache.getContext("2d");e.clearRect(0,0,this.terrain.w*this.tileSize,this.terrain.h*this.tileSize),e.save(),e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=1,e.shadowColor="#444",e.drawImage(this.canvasTerrain,0,0),e.restore();for(let t=0;t<this.terrain.cells.length;t++){let i=this.terrain.cells[t];this.renderCellUI(e,i)}this.canvasCacheOutdated=!1}resetCanvasCache(){this.canvasCacheOutdated=!0}text(t,e){let i=h(t,[0,-10]);this.anim.push(new w(e,"#f00",3,i,[0,-10]))}renderBullet(t,[e,i],s){t.beginPath();let a=d(c(i,e),-20),n=v(e,i,s);this.lookAt(n);let r=h(n,a);var o=t.createLinearGradient(r[0],r[1],n[0],n[1]);o.addColorStop(0,"rgba(0,0,0,0)"),o.addColorStop(1,"rgba(0,0,0,1)"),t.lineWidth=4,t.strokeStyle=o,t.moveTo(...r),t.lineTo(...n),t.stroke(),t.lineWidth=1,t.strokeStyle="#000"}insideScreen(t){return(t=h(t,this.screenPos))[0]>=k&&t[1]>=k&&t[0]<=this.width-k&&t[1]<=this.height-k}lookAtCid(t){this.lookAt(this.cidToCenterPoint(t))}lookAt(t){this.insideScreen(t)||(this.lookingAt=[-t[0]+this.width/2,-t[1]+this.height/2])}shoot(t,e,i){let s,a,n,r,o=[t,e].map(t=>this.terrain.cells[t]);t:for(n of o[0].povs)for(r of o[1].povs)if(n.rfov.has(r.cid)){s=[n,r].map(t=>this.cidToCenterPoint(t.cid));break t}if(i>0)a=s[1];else{let t=d(c(s[1],s[0]));a=h(h(s[1],[(l=t)[1],-l[0]]),t,10*this.tileSize)}var l;let u=this.dollAt(t),p=this.dollAt(e),g=0;n.cid==t&&r.cid==e&&(g=1),this.animQueue.push({update:n=>{if(g>=1&&g<=2)g+=n*Math.min(10,1e3/m(s[0],a)*this.animationSpeed);else{let i=.6*(g<1?g:3-g);for(let a=0;a<2;a++){[u,p][a].at=v(this.cidToPoint([t,e][a]),c(s[a],[this.tileSize/2,this.tileSize/2]),i)}g+=n*this.animationSpeed*10}return!(g>3)||(this.text(s[1],i>0?`-${i}`:"MISS"),u.at=this.cidToPoint(u.unit.cid),p.at=this.cidToPoint(p.unit.cid),!1)},render:t=>{g>1&&g<2&&this.renderBullet(t,[s[0],a],g-1)}})}walk(t,e){let i=e.map(t=>this.cidToPoint(t.cid)),s=0;this.animQueue.push({update:e=>(s+=15*e*this.animationSpeed,i[Math.floor(s)+1]?(t.at=v(i[Math.floor(s)],i[Math.floor(s)+1],s-Math.floor(s)),this.lookAt(t.at),!0):(t.at=i[i.length-1],!1))})}dollOf(t){return this.dolls.find(e=>e.unit==t)}dollAt(t){return this.dolls.find(e=>e.unit.cid==t)}draw(t){return i(this,void 0,void 0,function*(){switch(t.anim){case"walk":this.walk(this.dollOf(t.char),t.path);break;case"shoot":this.shoot(t.from,t.to,t.damage)}yield this.waitForAnim()})}waitForAnim(){return new Promise(t=>{this.blockingAnimationEnd=(()=>t())})}get busy(){return this.animQueue.length>0}initSprites(){this.ap1Sprite=n([this.tileSize,this.tileSize],t=>{t.strokeStyle="#555",t.strokeRect(4.5,4.5,this.tileSize-8,this.tileSize-8)}),this.ap2Sprite=n([this.tileSize,this.tileSize],t=>{t.strokeStyle="#bbb",t.strokeRect(4.5,4.5,this.tileSize-8,this.tileSize-8)}),this.hiddenSprite=n([this.tileSize,this.tileSize],t=>{t.fillStyle="rgba(0,0,0,0.12)",t.fillRect(0,0,this.tileSize,this.tileSize)}),this.dashPattern=n([T,T],t=>{for(let e=0;e<T;e++)t.fillRect(e,e,1,1)}),this.wavePattern=n([8,8],t=>{t.beginPath(),t.arc(4.5,2,5,0,Math.PI),t.stroke()}),this.crossPattern=n([3,3],t=>{for(let e=0;e<T;e++)t.fillRect(T-e-1,e,1,1),t.fillRect(e,e,1,1)}),this.highTile=n([this.tileSize,this.tileSize],t=>{t.fillStyle="#000",t.fillRect(0,0,this.tileSize,this.tileSize)}),this.lowTile=n([this.tileSize,this.tileSize],t=>{t.fillStyle="#fff",t.fillRect(0,0,this.tileSize,this.tileSize),t.fillStyle=t.createPattern(this.dashPattern,"repeat"),t.fillRect(0,0,this.tileSize,this.tileSize)}),this.waterTile=n([this.tileSize,this.tileSize],t=>{t.fillStyle=t.createPattern(this.wavePattern,"repeat"),t.fillRect(0,0,this.tileSize,this.tileSize)})}}let _=[{name:"Default Campaign",version:"0.1",author:"Baturinsky, Red Knight",stage:"Red Knight's Backyard",guns:{carbine:{name:"Carbine",damage:[4,5],damagePenaltyPerCell:100,accuracyPenaltyMax:20,accuracy:60,accuracyOptimalRange:[1,1],accuracyPenaltyPerCell:1,damagePenaltyMax:2,breach:0},sniper:{name:"Sniper",damageOptimalRange:[1,30],damagePenaltyPerCell:.1,accuracyOptimalRange:[10,30],accuracyPenaltyPerCell:1,breach:1,aggression:-.1},shotgun:{name:"Shotgun",damage:[6,7],damageOptimalRange:[1,1],damagePenaltyMax:4,damagePenaltyPerCell:.3,accuracy:80,accuracyOptimalRange:[1,1],accuracyPenaltyPerCell:5,accuracyPenaltyMax:40,aggression:.1}},units:{g:{name:"Gunner",speed:4,maxHP:14,gun:"carbine"},a:{name:"Assault",speed:6,armor:1,gun:"shotgun"},s:{name:"Sharpshooter",maxHP:7,def:10,gun:"sniper"}},stages:[{name:"Backyard 13",version:"1",author:"baturinsky",terrain:"\n    ##################################################\n    #      #  a      ++++# + #    ++#  s             #\n    # #    #  +         +#   #    ++#  ++++++++      #\n    #      +  +         +#   #    ++#  ++++++++      #\n    #S#    +  +         +# * #      #                #\n    #      #  +          #   #      #                #\n    # #    #             #   #      #                #\n    #      #  +          ##a## ######                #\n    #             *                                  #\n    #                                                #\n    #A#    #             #s         #a     ~~~       #\n    #      #  +          #          #    ~~~~~~      #\n    #A#    #  #      #a  #  ###    ++   ~~~#A#~~~    #\n    #      #  #      #   #  #      ++       * ~~~    #\n    #G#    #  ########   #  #      +#    ~ # #~~     #\n    #      #             #          #    ~~~~~~~     #\n    # #    ######  ###########  #####      ~~~~      #\n    #      #++++      ++ # +        #                #\n    #S#    #+            # +   ++   +                #\n    #      #            +#          #                #\n    #         ######g    #       +  #                #\n    #         ######g    #####  #####                #\n    #                    #   g      #      #        +#\n    #      #          +  #                         ++#\n    #G#    #+    *       #+++    +++#   #     #    ++#\n    #      #++      +    #          #g               #\n    # #    ######++###########++##########    ########\n    #                 S+                             #\n    #         +              A+                      #\n    ##################################################\n    "},{name:"Red Knight's Backyard",version:"1",author:"Red Knight",terrain:"\n    ##################################################\n    ################# g+         ###++    ##      ++##\n    ################# ++         +                 +##\n    ####################               a+          +##\n    #################                   +    +      ##\n    #################* #          ++++      ##      ##\n    ####################                     +      ##\n    #################        +# + #+a##     g#   ++g##\n    ##################+##  ####################  +####\n    ###   +++  #*+  # g#   a###################      #\n    ###       a#   +# +#    ##########+#++++  #   # *#\n    #   +      ###  #  #    #        # a+++   #   ####\n    #  g+        #  #+ #       +  +  #              ##\n    #   +        ## ## #      g+  +     +           ##\n    #                  #  g #        #+  +++  #     ##\n    #    + ## ####  #     ++#  +  +  #a  +#+  #     ##\n    #    + g# +###  ####    #######  ##########     ##\n    #++  + ## ##a+  +  #   +##+a+     + #  +  ##+   ##\n    #       # +#       #++ +# + +   +g+ # ++ +#+    ##\n    #       # +#   +   #+         +++               ##\n    #   #++## +## #+# ##            +               ##\n    #   +         +         #         ++      #     ##\n    #                  #    # ####### ### ## ### +  ##\n    #   #  a+          #g   # a*##++a     #+  #  +  ##\n    #~~~~~~~~~ ~~~~~~####  ###########++######## +  ##\n    #~~~~~~~~# #~~~~~~##    a+#+ +                  ##\n    #~~~~~~~~ *              +     # ##         SAGA##\n    ###~~~~~~# #~~~~~~~~           #  #         SGGA##\n    ####~~~~~~~~~~~~~~~#           # *#         SAAA##\n    ##################################################\n    "}]}];class M{constructor(t){this.updateUI=t,this.time=0,this.aiSides=M.PAI,this.momentum=[0,0],this.renderer=new z(this),this.init()}static loadCampaign(t){return l(localStorage.getItem(M.campaignPrefix+t))}static campaignById(t){return _.find(e=>e.name==t||e.name+" "+e.version==t)||M.loadCampaign(t)||_[0]}static savedCampaignIds(){return Object.keys(localStorage).filter(t=>t.substr(0,M.savePrefixLength)==M.campaignPrefix).map(t=>t.substr(M.savePrefixLength)).sort().reverse()}static allCampaignIds(){return _.map(t=>t.name+" "+t.version).concat(M.savedCampaignIds())}stageByName(t){return this.campaign.stages.find(e=>e.name==t)||this.campaign.stages[0]}init(t,e=!0){let i;delete this.chosen,delete this.hovered,delete this.lastSelectedFaction,t&&((i=l(t)).campaign?this.campaign=M.campaignById(i.campaign):(this.campaign=i,this.customCampaign=!0)),this.campaign||(this.campaign=M.campaignById()),this.init2(this.campaign,this.stageByName(i&&i.stage),i&&e?i.state:null)}makeNotCustom(){this.customCampaign=!1}init2(t,e,i){this.campaign=t,this.stage=e,this.terrain=new x(this.campaign,this.stage,i||null,t=>this.renderer.draw(t)),this.renderer.synch(),this.updateUI({activeTeam:this.activeTeam})}initStage(t){this.init2(this.campaign,this.campaign.stages[t])}serialize(t={state:!0}){let e={};return t.campaign||this.customCampaign?Object.assign(e,this.campaign):e.campaign=this.campaign.name,t.state&&(e.state=this.terrain.serialize()),e.stage=this.stage.name,JSON.stringify(e,null,"  ").replace(/\\n/g,"\n")}setCanvas(t){this.canvas=t,this.ctx=t.getContext("2d"),this.renderer&&this.renderer.resize()}over(){return!1}update(t){this.lastLoopTimeStamp||(this.lastLoopTimeStamp=t-.001);let e=Math.min(.02,(t-this.lastLoopTimeStamp)/1e3);this.lastLoopTimeStamp=t,this.time+=e,this.renderer.update(e),this.renderer.render(this.ctx),this.over()&&this.updateUI({over:!0}),this.chosen&&!this.chosen.alive&&delete this.chosen}updateTooltip(t,e){this.updateUI({tooltipAt:t,tooltipText:e})}click(t,e){let i=this.renderer.cellAtScreenPos(t,e);this.clickCell(i),this.renderer.resetCanvasCache()}isAi(t){return this.aiSides&1<<t.faction}canPlayAs(t){return!this.isAi(t.team)}choose(t){this.chosen=t,t&&(this.lastChosen=this.chosen,this.chosen.calculate(),this.renderer.lookAtCid(this.chosen.cid),this.renderer.resetCanvasCache())}clickCell(t){if(t){if(t.unit){if(this.chosen&&this.chosen.team==t.unit.team&&this.canPlayAs(t.unit))return void this.choose(t.unit);if(this.chosen&&this.chosen.canDamage(t.unit))return void this.chosen.shoot(t);this.chosen==t.unit?this.cancel():this.canPlayAs(t.unit)&&this.choose(t.unit),this.chosen&&this.chosen.calculate()}!t.unit&&this.chosen&&this.chosen.reachable(t)&&(this.chosen.move(t),this.terrain.teams[b.RED].calculate()),this.lastSelectedFaction=this.chosen?this.chosen.team:this.terrain.we}}cancel(){delete this.chosen,this.renderer.resetCanvasCache()}drag(t,e){this.renderer.screenPos=h(this.renderer.screenPos,[t,e])}hover(t,e){let i=this.renderer.cellAtScreenPos(t,e);if(this.hovered==i)return;if(!i)return delete this.hovered,void this.renderer.resetCanvasCache();if(!i)return;this.hovered=i;let s="default";(this.chosen&&this.chosen.reachable(i)||i.unit)&&(s="pointer"),this.chosen&&this.chosen.canDamage(i.unit)?(s="crosshair",this.updateTooltip(this.renderer.cidToCenterScreen(i.cid),`${this.chosen.hitChance(i)}% ${this.chosen.gun.averageDamage(this.chosen,i).toFixed(1)}`)):this.updateTooltip(),document.body.style.cursor=s,this.updateUI({chosen:this.chosen,unitInfo:i.unit}),this.renderer.busy||this.renderer.resetCanvasCache()}get blue(){return this.terrain.teams[b.BLUE]}get red(){return this.terrain.teams[b.RED]}get activeTeam(){return this.terrain.activeTeam}endTurn(t){return i(this,void 0,void 0,function*(){if(this.aiSides=t,this.isAi(this.activeTeam))yield this.endSideTurn();else do{yield this.endSideTurn()}while(this.isAi(this.activeTeam))})}endSideTurn(){return i(this,void 0,void 0,function*(){delete this.chosen;let t=this.activeTeam;this.isAi(t)&&(yield t.think()),this.terrain.endSideTurn(),this.renderer.resetCanvasCache(),this.updateUI({activeTeam:this.activeTeam})})}setAiSides(t){this.aiSides=t}get hoveredChar(){if(this.hovered)return this.hovered.unit}chooseNext(t=1){if(this.chosen){let e=this.chosen.team.units,i=e[(e.indexOf(this.chosen)+e.length+t)%e.length];this.choose(i)}else this.lastChosen?this.choose(this.lastChosen):this.choose(this.terrain.we.units[0])}}M.PAI=2,M.PP=0,M.AIAI=3,M.savePrefix="2aps:",M.campaignPrefix="2apc:",M.savePrefixLength=M.savePrefix.length,M.timeStampLength=13;var D=function(){},I={},E=[],N=[];function R(t,e){var i,s,a,n,r=N;for(n=arguments.length;n-- >2;)E.push(arguments[n]);for(e&&null!=e.children&&(E.length||E.push(e.children),delete e.children);E.length;)if((s=E.pop())&&void 0!==s.pop)for(n=s.length;n--;)E.push(s[n]);else"boolean"==typeof s&&(s=null),(a="function"!=typeof t)&&(null==s?s="":"number"==typeof s?s=String(s):"string"!=typeof s&&(a=!1)),a&&i?r[r.length-1]+=s:r===N?r=[s]:r.push(s),i=a;var o=new D;return o.nodeName=t,o.children=r,o.attributes=null==e?void 0:e,o.key=null==e?void 0:e.key,o}function O(t,e){for(var i in e)t[i]=e[i];return t}function L(t,e){t&&("function"==typeof t?t(e):t.current=e)}var B="function"==typeof Promise?Promise.resolve().then.bind(Promise.resolve()):setTimeout,U=/acit|ex(?:s|g|n|p|$)|rph|ows|mnc|ntw|ine[ch]|zoo|^ord/i,F=[];function W(t){!t._dirty&&(t._dirty=!0)&&1==F.push(t)&&B(G)}function G(){for(var t;t=F.pop();)t._dirty&&ot(t)}function H(t,e){return t.normalizedNodeName===e||t.nodeName.toLowerCase()===e.toLowerCase()}function V(t){var e=O({},t.attributes);e.children=t.children;var i=t.nodeName.defaultProps;if(void 0!==i)for(var s in i)void 0===e[s]&&(e[s]=i[s]);return e}function q(t){var e=t.parentNode;e&&e.removeChild(t)}function j(t,e,i,s,a){if("className"===e&&(e="class"),"key"===e);else if("ref"===e)L(i,null),L(s,t);else if("class"!==e||a)if("style"===e){if(s&&"string"!=typeof s&&"string"!=typeof i||(t.style.cssText=s||""),s&&"object"==typeof s){if("string"!=typeof i)for(var n in i)n in s||(t.style[n]="");for(var n in s)t.style[n]="number"==typeof s[n]&&!1===U.test(n)?s[n]+"px":s[n]}}else if("dangerouslySetInnerHTML"===e)s&&(t.innerHTML=s.__html||"");else if("o"==e[0]&&"n"==e[1]){var r=e!==(e=e.replace(/Capture$/,""));e=e.toLowerCase().substring(2),s?i||t.addEventListener(e,X,r):t.removeEventListener(e,X,r),(t._listeners||(t._listeners={}))[e]=s}else if("list"!==e&&"type"!==e&&!a&&e in t){try{t[e]=null==s?"":s}catch(t){}null!=s&&!1!==s||"spellcheck"==e||t.removeAttribute(e)}else{var o=a&&e!==(e=e.replace(/^xlink:?/,""));null==s||!1===s?o?t.removeAttributeNS("http://www.w3.org/1999/xlink",e.toLowerCase()):t.removeAttribute(e):"function"!=typeof s&&(o?t.setAttributeNS("http://www.w3.org/1999/xlink",e.toLowerCase(),s):t.setAttribute(e,s))}else t.className=s||""}function X(t){return this._listeners[t.type](t)}var Q=[],$=0,Y=!1,K=!1;function J(){for(var t;t=Q.shift();)t.componentDidMount&&t.componentDidMount()}function Z(t,e,i,s,a,n){$++||(Y=null!=a&&void 0!==a.ownerSVGElement,K=null!=t&&!("__preactattr_"in t));var r=tt(t,e,i,s,n);return a&&r.parentNode!==a&&a.appendChild(r),--$||(K=!1,n||J()),r}function tt(t,e,i,s,a){var n=t,r=Y;if(null!=e&&"boolean"!=typeof e||(e=""),"string"==typeof e||"number"==typeof e)return t&&void 0!==t.splitText&&t.parentNode&&(!t._component||a)?t.nodeValue!=e&&(t.nodeValue=e):(n=document.createTextNode(e),t&&(t.parentNode&&t.parentNode.replaceChild(n,t),et(t,!0))),n.__preactattr_=!0,n;var o,l,h=e.nodeName;if("function"==typeof h)return function(t,e,i,s){var a=t&&t._component,n=a,r=t,o=a&&t._componentConstructor===e.nodeName,l=o,h=V(e);for(;a&&!l&&(a=a._parentComponent);)l=a.constructor===e.nodeName;a&&l&&(!s||a._component)?(rt(a,h,3,i,s),t=a.base):(n&&!o&&(lt(n),t=r=null),a=at(e.nodeName,h,i),t&&!a.nextBase&&(a.nextBase=t,r=null),rt(a,h,1,i,s),t=a.base,r&&t!==r&&(r._component=null,et(r,!1)));return t}(t,e,i,s);if(Y="svg"===h||"foreignObject"!==h&&Y,h=String(h),(!t||!H(t,h))&&(o=h,(l=Y?document.createElementNS("http://www.w3.org/2000/svg",o):document.createElement(o)).normalizedNodeName=o,n=l,t)){for(;t.firstChild;)n.appendChild(t.firstChild);t.parentNode&&t.parentNode.replaceChild(n,t),et(t,!0)}var c=n.firstChild,u=n.__preactattr_,d=e.children;if(null==u){u=n.__preactattr_={};for(var m=n.attributes,p=m.length;p--;)u[m[p].name]=m[p].value}return!K&&d&&1===d.length&&"string"==typeof d[0]&&null!=c&&void 0!==c.splitText&&null==c.nextSibling?c.nodeValue!=d[0]&&(c.nodeValue=d[0]):(d&&d.length||null!=c)&&function(t,e,i,s,a){var n,r,o,l,h,c=t.childNodes,u=[],d={},m=0,p=0,g=c.length,f=0,v=e?e.length:0;if(0!==g)for(var y=0;y<g;y++){var S=c[y],b=S.__preactattr_,C=v&&b?S._component?S._component.__key:b.key:null;null!=C?(m++,d[C]=S):(b||(void 0!==S.splitText?!a||S.nodeValue.trim():a))&&(u[f++]=S)}if(0!==v)for(var y=0;y<v;y++){l=e[y],h=null;var C=l.key;if(null!=C)m&&void 0!==d[C]&&(h=d[C],d[C]=void 0,m--);else if(p<f)for(n=p;n<f;n++)if(void 0!==u[n]&&(P=r=u[n],w=a,"string"==typeof(x=l)||"number"==typeof x?void 0!==P.splitText:"string"==typeof x.nodeName?!P._componentConstructor&&H(P,x.nodeName):w||P._componentConstructor===x.nodeName)){h=r,u[n]=void 0,n===f-1&&f--,n===p&&p++;break}h=tt(h,l,i,s),o=c[y],h&&h!==t&&h!==o&&(null==o?t.appendChild(h):h===o.nextSibling?q(o):t.insertBefore(h,o))}var P,x,w;if(m)for(var y in d)void 0!==d[y]&&et(d[y],!1);for(;p<=f;)void 0!==(h=u[f--])&&et(h,!1)}(n,d,i,s,K||null!=u.dangerouslySetInnerHTML),function(t,e,i){var s;for(s in i)e&&null!=e[s]||null==i[s]||j(t,s,i[s],i[s]=void 0,Y);for(s in e)"children"===s||"innerHTML"===s||s in i&&e[s]===("value"===s||"checked"===s?t[s]:i[s])||j(t,s,i[s],i[s]=e[s],Y)}(n,e.attributes,u),Y=r,n}function et(t,e){var i=t._component;i?lt(i):(null!=t.__preactattr_&&L(t.__preactattr_.ref,null),!1!==e&&null!=t.__preactattr_||q(t),it(t))}function it(t){for(t=t.lastChild;t;){var e=t.previousSibling;et(t,!0),t=e}}var st=[];function at(t,e,i){var s,a=st.length;for(t.prototype&&t.prototype.render?(s=new t(e,i),ht.call(s,e,i)):((s=new ht(e,i)).constructor=t,s.render=nt);a--;)if(st[a].constructor===t)return s.nextBase=st[a].nextBase,st.splice(a,1),s;return s}function nt(t,e,i){return this.constructor(t,i)}function rt(t,e,i,s,a){t._disable||(t._disable=!0,t.__ref=e.ref,t.__key=e.key,delete e.ref,delete e.key,void 0===t.constructor.getDerivedStateFromProps&&(!t.base||a?t.componentWillMount&&t.componentWillMount():t.componentWillReceiveProps&&t.componentWillReceiveProps(e,s)),s&&s!==t.context&&(t.prevContext||(t.prevContext=t.context),t.context=s),t.prevProps||(t.prevProps=t.props),t.props=e,t._disable=!1,0!==i&&(1!==i&&!1===I.syncComponentUpdates&&t.base?W(t):ot(t,1,a)),L(t.__ref,t))}function ot(t,e,i,s){if(!t._disable){var a,n,r,o=t.props,l=t.state,h=t.context,c=t.prevProps||o,u=t.prevState||l,d=t.prevContext||h,m=t.base,p=t.nextBase,g=m||p,f=t._component,v=!1,y=d;if(t.constructor.getDerivedStateFromProps&&(l=O(O({},l),t.constructor.getDerivedStateFromProps(o,l)),t.state=l),m&&(t.props=c,t.state=u,t.context=d,2!==e&&t.shouldComponentUpdate&&!1===t.shouldComponentUpdate(o,l,h)?v=!0:t.componentWillUpdate&&t.componentWillUpdate(o,l,h),t.props=o,t.state=l,t.context=h),t.prevProps=t.prevState=t.prevContext=t.nextBase=null,t._dirty=!1,!v){a=t.render(o,l,h),t.getChildContext&&(h=O(O({},h),t.getChildContext())),m&&t.getSnapshotBeforeUpdate&&(y=t.getSnapshotBeforeUpdate(c,u));var S,b,C=a&&a.nodeName;if("function"==typeof C){var P=V(a);(n=f)&&n.constructor===C&&P.key==n.__key?rt(n,P,1,h,!1):(S=n,t._component=n=at(C,P,h),n.nextBase=n.nextBase||p,n._parentComponent=t,rt(n,P,0,h,!1),ot(n,1,i,!0)),b=n.base}else r=g,(S=f)&&(r=t._component=null),(g||1===e)&&(r&&(r._component=null),b=Z(r,a,h,i||!m,g&&g.parentNode,!0));if(g&&b!==g&&n!==f){var x=g.parentNode;x&&b!==x&&(x.replaceChild(b,g),S||(g._component=null,et(g,!1)))}if(S&&lt(S),t.base=b,b&&!s){for(var w=t,k=t;k=k._parentComponent;)(w=k).base=b;b._component=w,b._componentConstructor=w.constructor}}for(!m||i?Q.push(t):v||t.componentDidUpdate&&t.componentDidUpdate(c,u,y);t._renderCallbacks.length;)t._renderCallbacks.pop().call(t);$||s||J()}}function lt(t){var e=t.base;t._disable=!0,t.componentWillUnmount&&t.componentWillUnmount(),t.base=null;var i=t._component;i?lt(i):e&&(null!=e.__preactattr_&&L(e.__preactattr_.ref,null),t.nextBase=e,q(e),st.push(t),it(e)),L(t.__ref,null)}function ht(t,e){this._dirty=!0,this.context=e,this.props=t,this.state=this.state||{},this._renderCallbacks=[]}function ct(){return R("div",{id:"help"},R("h3",null,"This is a prototype of a browser XCOM-like game."),R("p",null,"Currently it only has three unit types, no complex moves like overwatch, and only one map, but it will grow. It's already fully playable and closely matches XCOM conventions. Left click on your",R("span",{style:"color:blue"},"(blue)"),' units to select, click on empty space to move or on enemy to fire. Right click to deselect. Each unit has two action points (hence the game\'s name), shown as "horns". And some Hit Points, shown as the "beard". Units, naturally, die when out of HP, but can replenish HPs with "*" pickups. When next to cover (black or dashed squares), unit is protected by it on respective side and can "peek" out of it to shoot or, sadly, be shot at, just like in XCOM. Black squares are high cover, granting 40% defence and blocking vision. Dashed squares are low cover, giving only 20$ defence and no LOS obsruction.'),R("p",null,"When you hover the mouse over the square, you can see what is visible from it, and which enemies are flanked from (i.e. have no cover, marked"," ",R("span",{style:"background:#8f8"},"green"),"), or",R("span",{style:"background:#f88"},"flanking")," this square, or",R("span",{style:"background:#ff8;"},"both"),"."),R("p",null,'You can play against AI, it\'s a default mode. AI is quite competent, seeking cover and trying to flank you when possible. Also you can switch to 2 player mode, or even AI vs AI. Difference, basically, is that when you press "End turn", AI will make moves, depending on mode, for none, one or both sides if they have APs remained.'),R("p",null,'Even more, you can play on your own map! Just switch to Edit mode, and edit text field. # is high cover, + is low cover, G, A, S are blue units and g, a, s are red units. Note that map borders should always be high cover. Don\'t forget to press "Apply" when you done.'))}O(ht.prototype,{setState:function(t,e){this.prevState||(this.prevState=this.state),this.state=O(O({},this.state),"function"==typeof t?t(this.state,this.props):t),e&&this._renderCallbacks.push(e),W(this)},forceUpdate:function(t){t&&this._renderCallbacks.push(t),ot(this,2)},render:function(){}});var ut=Object.freeze({Sharpshooter:"\nHits accurately and hard at long range, regardless of target's armor.\nHas extra defence, making him nearly untouchable when in cover. \nPretty helpess up close and has low HP.\n",Assault:"\nPsycho with a shotgun. \nFast and even has a bit of armor to survive close quater fight a bit longer.\nCan deal a lot of damage, but only up close.\n",Gunner:"\nEffective in any range and has extra hp.\nQuite slow.\n"});let dt=!1;class mt extends ht{constructor(){super(...arguments),this.state={campaign:null,campaignInd:-1}}render(){return R("div",{class:"new-game row"},R("div",null,R("h4",null,"Campaigns"),this.props.campaigns.map((t,e)=>R("div",null,R("button",{class:e==this.state.campaignInd?"long pressed":"long",onClick:()=>this.selectCampaign(e)},0==t.search(/[0-9]{13}/)?t.substr(M.timeStampLength):t)))),R("div",null,this.state.campaign&&[R("h4",null,"Scenarios"),this.state.campaign.stages.map((t,e)=>R("div",null,R("button",{class:"long",onClick:()=>this.startStage(e)},t.name)))]))}selectCampaign(t){this.setState({campaign:M.campaignById(this.props.campaigns[t]),campaignInd:t})}startStage(t){this.props.startStage(this.state.campaign,this.state.campaign.stages[t])}}let pt=t=>{let e=!1;return R("div",{class:"save"},R("button",{onClick:t.save},"Save Game"),t.saves.sort().reverse().concat([null],t.campaigns.sort().reverse()).map(i=>i?R("div",{class:"save-row"},R("button",{class:"short",onClick:()=>t.del(i)},"Del")," ",new Date(+i.substr(0,M.timeStampLength)).toLocaleString(),R("input",{class:"save-name",disabled:e,onChange:e=>t.changeName(i,e.target.value),value:i.substr(M.timeStampLength)}),R("button",{onClick:()=>t.load(i)},"Load")):(e=!0,[R("h4",null,"Custom Campaigns"),t.saveCampaign&&R("button",{onClick:t.saveCampaign},"Save Campaign")])))};class gt extends ht{constructor(t){super(t),this.state={aiSides:2,activeTeam:null,page:"play",game:void 0,stageEdit:"",modCampaign:!0,modState:!0,saves:[],campaigns:[],unitInfo:null,chosen:null,aiTurn:!1,tooltipText:null,tooltipAt:null},this.canvas={},this.tooltip={},this.updateUI=(t=>{this.setState(t)}),document.addEventListener("keydown",t=>{switch(t.code){case"Escape":"menu"==this.page?this.setPage("play"):this.setPage("menu");break;case"Tab":this.game.chooseNext();break;case"KeyS":t.shiftKey&&this.setPage("saves")}})}get game(){return this.state.game}get page(){return this.state.page}gameUpdated(t){this.setState({game:t})}updateSaves(){let t=[],e=[];for(let i in localStorage){let s=i.substr(0,M.savePrefixLength);s==M.savePrefix&&t.push(i.substr(M.savePrefixLength)),s==M.campaignPrefix&&e.push(i.substr(M.savePrefixLength))}this.setState({saves:t,campaigns:e})}updateStageEdit(){this.setState({stageEdit:this.game.serialize({campaign:this.state.modCampaign,state:this.state.modState})})}setPage(t){"edit"==this.state.page&&this.state.stageEdit&&this.game.init(this.state.stageEdit),this.setState({page:t}),"edit"==t&&this.updateStageEdit(),"play"!=t&&(document.body.style.cursor="default")}cancelEdit(){this.setState({stageEdit:null}),this.setPage("menu")}endTurn(){this.game.endTurn(this.state.aiSides)}componentDidMount(){this.gameUpdated(new M(this.updateUI)),this.updateSaves();let t=this.canvas.current;!function(t,e){let i=0;e.addEventListener("mouseup",t=>{i=0}),e.addEventListener("mousedown",e=>{0==e.button&&t.game.click(e.offsetX,e.offsetY),2==e.button&&t.game.cancel(),"play"==t.state.page&&(3==e.button&&("#prev"==location.hash?history.forward():history.pushState({},document.title,"#prev"),t.game.chooseNext()),4==e.button&&t.game.chooseNext(-1))}),e.addEventListener("mousemove",e=>{6&e.buttons&&++i>=3&&t.game.drag(e.movementX,e.movementY),t.game.hover(e.offsetX,e.offsetY)}),e.addEventListener("mouseleave",e=>{t.game.hover()}),e.addEventListener("mouseenter",t=>{}),e.addEventListener("contextmenu",function(t){t.preventDefault()},!1)}(this,t),this.game.setCanvas(t),window.onresize=(()=>{this.game.renderer.resize()}),function t(e){requestAnimationFrame(i=>{e(i),t(e)})}(t=>{!this.game||dt||this.game.over()||this.game.update(t)})}displayIfPage(t){return this.state.page==t?"display:flex":"display:none"}toggleAI(t){let e=this.state.aiSides^1<<t;this.setState({aiSides:e}),this.game.setAiSides(e)}topButtons(){return"play"==this.state.page?[["AI",()=>this.toggleAI(0)],["AI",()=>this.toggleAI(1)],[void 0,void 0],["Menu","menu"]]:[["New Game","new-game"],["Saves","saves"],["Settings","settings"],["Editor","edit"],["Help","help"],[void 0,void 0],["Continue","play"]]}saveCampaign(){let t=this.state.game.serialize({campaign:!0,state:!1}),e=(new Date).getTime()+this.state.game.campaign.name;localStorage.setItem(M.campaignPrefix+e,t),this.updateSaves()}saveGame(){let t=this.state.game.serialize(),e=(new Date).getTime()+this.state.game.campaign.name+": "+this.state.game.stage.name;localStorage.setItem(M.savePrefix+e,t),this.updateSaves()}delGame(t){localStorage.removeItem(M.savePrefix+t),localStorage.removeItem(M.campaignPrefix+t),this.updateSaves()}loadGame(t){let e=localStorage.getItem(M.savePrefix+t);e?this.game.init(e):(e=localStorage.getItem(M.campaignPrefix+t),this.game.init(e,!1)),this.setPage("play")}changeGameName(t,e){let i=M.savePrefix+(new Date).getTime()+e,s=M.savePrefix+t;localStorage[i]||i==s||(localStorage.setItem(i,localStorage[s]),localStorage.removeItem(s),this.updateSaves())}startStage(t,e){this.game.init2(t,e),this.game.makeNotCustom(),this.setPage("play")}renderPage(){switch(this.state.page){case"help":return R(ct,null);case"saves":return R(pt,{saves:this.state.saves,campaigns:this.state.campaigns,saveCampaign:this.game.customCampaign&&this.saveCampaign,save:this.saveGame,load:this.loadGame,del:this.delGame,changeName:this.changeGameName});case"new-game":return R(mt,{campaigns:M.allCampaignIds(),startStage:(t,e)=>this.startStage(t,e)});default:return R("div",null)}}toggleModCampaign(){this.setState({modCampaign:!this.state.modCampaign}),this.updateStageEdit()}toggleModState(){this.setState({modState:!this.state.modState}),this.updateStageEdit()}sideButtonText(t){let e=R("span",null,this.state.aiSides&1<<t?"AI":"Player");return this.state.activeTeam&&this.state.activeTeam.faction==t&&(e=R("u",null,e)),e}render(){let t=this.state,e=t.page;return R("div",null,R("div",{class:"center-screen",style:this.displayIfPage("play")},R("canvas",{ref:this.canvas,id:"main"})),R("div",{class:"center-horisontal"},R("div",{id:"editor",style:this.displayIfPage("edit")},R("textarea",{onChange:(i=this,s="stageEdit",n=s.split("."),r=i.__lsc||(i.__lsc={}),r[s+a]||(r[s+a]=function(t){for(var e=t&&t.target||this,s={},r=s,o="string"==typeof a?function(t,e,i,s){for(s=0,e=e.split?e.split("."):e;t&&s<e.length;)t=t[e[s++]];return void 0===t?i:t}(t,a):e.nodeName?e.type.match(/^che|rad/)?e.checked:e.value:t,l=0;l<n.length-1;l++)r=r[n[l]]||(r[n[l]]=!l&&i.state[n[l]]||{});r[n[l]]=o,i.setState(s)})),cols:100,rows:40,value:this.state.stageEdit,id:"edit-area"}),R("div",{class:"row"},R("label",null,R("input",{type:"checkbox",checked:t.modCampaign,onChange:this.toggleModCampaign}),"Modify Campaign"),R("label",null,R("input",{type:"checkbox",checked:t.modState,onChange:this.toggleModState}),"Modify State"),R("span",{class:"flex-spacer"}),R("button",{id:"endb",onClick:t=>this.cancelEdit()},"Cancel"))),[this.renderPage()]),R("div",{class:"top-buttons row"},this.topButtons().map(([t,i],s)=>t?R("button",{class:"medium"+("play"==e&&s<=2?" side"+s:"")+(e==i?" pressed":""),onClick:t=>i instanceof Function?i():this.setPage(i)},"play"==e&&s<=2?this.sideButtonText(s):t):R("span",{class:"flex-spacer"}))),t.unitInfo&&"play"==e&&R(ft,{unit:t.unitInfo,chosen:this.state.chosen}),R("div",{class:"bottom-buttons row"},R("span",{class:"flex-spacer"}),"play"==e&&!t.aiTurn&&R("button",{id:"endb",onClick:t=>this.endTurn()},"End Turn")),R("div",{id:"tooltip",style:t.tooltipAt?`display:block; left:${t.tooltipAt[0]+30+this.canvas.current.offsetLeft}; top:${t.tooltipAt[1]}`:"display:none"},t.tooltipText));var i,s,a,n,r}}e([o],gt.prototype,"saveCampaign",null),e([o],gt.prototype,"saveGame",null),e([o],gt.prototype,"delGame",null),e([o],gt.prototype,"loadGame",null),e([o],gt.prototype,"changeGameName",null),e([o],gt.prototype,"toggleModCampaign",null),e([o],gt.prototype,"toggleModState",null);let ft=({unit:t,chosen:e})=>{let i={},s=0;return t&&e&&t!=e&&(s=e.hitChance(t.cell,t,!1,i)),R("div",{id:"unitInfo"},t.name.toUpperCase()," ",R("b",null,t.hp),"HP ",R("b",null,t.ap),"AP"," ",R("b",null,t.stress),"SP",R("br",null),"velocity",vt(t.velocity)," focus",vt(t.focus),R("br",null),s&&R("div",null,"Hit Chance: ",R("b",null,s),Object.keys(i).filter(t=>i[t]).map(t=>R("span",{class:"nobr"}," ",t,R("b",null,function(t){return(t>0?"+":"")+t}(i[t]))))),ut[t.name])};function vt(t){let e=Math.atan2(t[1],t[0])/Math.PI*180,i=Math.round(u(t));return R("span",null,R("svg",{width:"10px",height:"10px"},R("path",{d:"M5 5 l 0 -5 l 5 5 l -5 5 l 0 -4 l -5 0 l 0 -2 l 5 0 ",transform:`rotate(${e} 5 5)`})),R("b",null,i))}return window.onload=function(){var t,e,i;t=R(gt,null),e=document.body,Z(i,t,{},!1,e,!1)},t.mouseAt=void 0,t}({});
