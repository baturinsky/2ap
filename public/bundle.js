var app=function(t){"use strict";function e(t,e){let i=function(t,e){let i=Number.MAX_VALUE,s=-1;for(let a=0;a<t.length;a++){let n=e(t[a]);i>n&&(i=n,s=a)}if(s>=0)return{ind:s,item:t[s],val:i}}(t,t=>-e(t));if(i)return i.val=-i.val,i}function i(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,i}function s(t,e){const s=i(...t),a=s.getContext("2d");return a.lineWidth=1,a.strokeStyle="#000",e(a),s}function a(t,e){return Math.floor(t/e)}function n(t,e,i,s){return new(i||(i=Promise))(function(a,n){function r(t){try{l(s.next(t))}catch(t){n(t)}}function h(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){t.done?a(t.value):new i(function(e){e(t.value)}).then(r,h)}l((s=s.apply(t,e||[])).next())})}function r(t,e,i=1){return[t[0]+e[0]*i,t[1]+e[1]*i]}function h(t,e){return[t[0]-e[0],t[1]-e[1]]}function l(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function o(t,e){return l([t[0]-e[0],t[1]-e[1]])}function c(t,e,i){return[t[0]*(1-i)+i*e[0],t[1]*(1-i)+i*e[1]]}function d(t,e,i,s){var a=function(n,r,h,l){if(!(r>=h)){for(var o=Math.round((n-.5)*r),c=Math.ceil((n+.5)*h-.5),d=o;d<=c;d++){var u=t+l.xx*d+l.xy*n,f=e+l.yx*d+l.yy*n;if(i(u,f))d>=n*r&&d<=n*h&&s(u,f);else if(d>=(n-.5)*r&&d-.5<=n*h&&s(u,f),a(n+1,r,(d-.5)/n,l),(r=(d+.5)/n)>=h)return}a(n+1,r,h,l)}},n=[{xx:1,xy:0,yx:0,yy:1},{xx:1,xy:0,yx:0,yy:-1},{xx:-1,xy:0,yx:0,yy:1},{xx:-1,xy:0,yx:0,yy:-1},{xx:0,xy:1,yx:1,yy:0},{xx:0,xy:1,yx:-1,yy:0},{xx:0,xy:-1,yx:1,yy:0},{xx:0,xy:-1,yx:-1,yy:0}];s(t,e);for(var r=0;r<8;r++)a(1,0,1,n[r])}class u{constructor(t,e,i,s){this.terrain=t,this.cid=e,this.obstacle=i,this.unit=s,this.rfov=new Set,this.xfov=new Set,this.dfov=new Set,this.povs=[],this.peeked=[]}calculatePovAnCover(){this.obstacle||(this.cover=this.terrain.obstacles(this.cid),this.peekSides())}calculateFov(){if(this.opaque)return;let t=this.terrain,[e,i]=this.at,s=new Set;d(e,i,(e,i)=>!t.cellAt(e,i).opaque,(e,i)=>{s.add(t.cid(e,i))}),this.rfov=s}calculateXFov(){let t=new Set;for(let e of this.povs)for(let i of e.rfov){let e=this.terrain.cells[i];for(let i of e.peeked)t.add(i.cid)}this.xfov=t}calculateDFov(){let t=new Set;for(let e of this.povs)for(let i of e.rfov)t.add(i);this.dfov=t}get at(){return this.terrain.fromCid(this.cid)}dist(t){return o(this.at,t.at)}seal(){this.obstacle=2,delete this.unit,this.goody=0}get opaque(){return 2==this.obstacle}get passable(){return this.obstacle<2&&!this.hole}get standable(){return 0==this.obstacle&&!this.hole&&!this.unit}peekSides(){this.povs=[];let t=this.terrain,e=this.cid;this.povs.push(this);for(let i=0;i<8;i+=2){let s=e+t.dir8Deltas[i];if(!t.cells[s].obstacle)continue;let a=[e+t.dir8Deltas[(i+6)%8],e+t.dir8Deltas[(i+7)%8]],n=[e+t.dir8Deltas[(i+2)%8],e+t.dir8Deltas[(i+1)%8]];for(let e of[a,n]){0==t.cells[e[0]].obstacle&&t.cells[e[1]].obstacle<=1&&this.povs.push(t.cells[e[0]])}}for(let t of this.povs)t.peeked.push(this)}}class f{constructor(t){this.damageOptimalRange=[1,20],this.damage=[4,5],this.damagePenaltyPerCell=100,this.accuracyPenaltyMax=20,this.accuracy=60,this.accuracyOptimalRange=[1,1],this.accuracyPenaltyPerCell=1,this.damagePenaltyMax=2,this.breach=0,this.name="Gun",t&&Object.assign(this,t)}damagePenalty(t){let e=0;return t<this.damageOptimalRange[0]&&(e=this.damageOptimalRange[0]-t),t>this.damageOptimalRange[1]&&(e=t-this.damageOptimalRange[1]),Math.min(this.damagePenaltyMax,this.damagePenaltyPerCell*e)}accuracyPenalty(t){let e=0;return t<this.accuracyOptimalRange[0]&&(e=this.accuracyOptimalRange[0]-t),t>this.accuracyOptimalRange[1]&&(e=t-this.accuracyOptimalRange[1]),Math.min(this.accuracyPenaltyMax,this.accuracyPenaltyPerCell*e)}averageDamage(t,e,i){i||(i=e.cell);let s=.5*(this.damage[1]+this.damage[0]);return s-=Math.max(0,e.armor-this.breach),s-=this.damagePenalty(t.dist(i)),Math.max(0,Math.round(10*s)/10)}damageRoll(t,e,i){let s=i()*(this.damage[1]-this.damage[0])+this.damage[0];return s-=Math.max(0,e.armor-this.breach),s-=this.damagePenalty(t.dist(e)),Math.max(0,Math.round(s))}}f.SNIPER=new f({name:"Sniper",damageOptimalRange:[1,30],damagePenaltyPerCell:.1,accuracyOptimalRange:[10,30],accuracyPenaltyPerCell:1,breach:1}),f.SHOTGUN=new f({name:"Shotgun",damage:[6,7],damageOptimalRange:[1,1],damagePenaltyMax:4,damagePenaltyPerCell:.3,accuracy:80,accuracyOptimalRange:[1,1],accuracyPenaltyPerCell:5,accuracyPenaltyMax:40});var m=Object.freeze({sniper:"\nHits accurately and hard at long range, regardless of target's armor.\nHas extra defence, making him nearly untouchable when in cover. \nPretty helpess up close and has low HP.\n",assault:"\nPsycho with a shotgun. \nFast and even has a bit of armor to survive close quater fight a bit longer.\nCan deal a lot of damage, but only up close.\n",gunner:"\nEffective in any range and has extra hp.\nQuite slow.\n"});class g{constructor(t,e){this.terrain=t,this.faction=e,this.fov=new Set}calculate(){this.strength=[],this.weakness=[],this.distance=[];let t=this.terrain;this.fov.clear();for(let t of this.units)for(let e of t.cell.xfov)this.fov.add(e);let e=this.terrain.teams[1-this.faction];for(let i of this.fov){let s=this.terrain.cells[i];for(let a of e.units){let e=a.cell,n=(4-t.cover(s,e))%5;this.strength[i]>n||(this.strength[i]=n);let r=(4-t.cover(e,s))%5;if(this.weakness[i]>r||(this.weakness[i]=r),n>0||r>0){let t=s.dist(e);this.distance[i]<=t||(this.distance[i]=t)}}}}think(){return n(this,void 0,void 0,function*(){this.terrain.aiTurn=!0,this.calculate();for(let t of this.terrain.units)t.team==this&&(yield t.think());this.terrain.aiTurn=!1})}get units(){return this.terrain.units.filter(t=>t.team==this)}get enemy(){return this.terrain.teams[1-this.faction]}get name(){return["RED","BLUE"][this.faction]}get color(){return["RED","BLUE"][this.faction]}}g.RED=0,g.BLUE=1;class v{constructor(t,e,i,s,a=new f){switch(this.terrain=t,this.kind=e,this.team=i,this.cid=s,this.gun=a,this.speed=5,this.maxHP=10,this.hp=this.maxHP,this.ap=2,this.armor=0,this.sight=20,this.def=0,e!=v.EYE&&t.units.push(this),e){case v.GUNNER:this.speed=4,this.hp=14;break;case v.ASSAULT:this.speed=6,this.armor=1,this.gun=f.SHOTGUN;break;case v.SNIPER:this.hp=7,this.def=10,this.gun=f.SNIPER}this.maxHP=this.hp}static from(t,e,i){let s=v.letters.indexOf(e);return s>=0?new v(t,s,t.teams[g.RED],i):(s=v.letters.indexOf(e.toLowerCase()))>=0?new v(t,s,t.teams[g.BLUE],i):void 0}get blue(){return this.team==this.terrain.we}pathTo(t){let e=t.cid,i=[e];for(;!((e=this.dists[e][1])<0);)i.push(e);return i.reverse().map(t=>this.terrain.cells[t])}get strokeColor(){return this.blue?"#00a":"#a00"}get x(){return this.cid%this.terrain.w}get y(){return a(this.cid,this.terrain.w)}get cell(){return this.terrain.cells[this.cid]}reachable(t){return this.apCost(t)<=this.ap}calculateDists(){this.dists=this.terrain.calcDists(this.cid)}calculate(){this.calculateDists()}cover(t){return this.terrain.cover(this.cell,t)}get at(){return this.terrain.fromCid(this.cid)}apCost(t){if(!this.dists)return Number.MAX_VALUE;let e=this.dists[t.cid][0];return Math.ceil(e/this.speed)}canShoot(){return this.ap>0}hitChance(t,e,i=!1){if(!(i?this.cell.dfov:this.cell.xfov).has((e||t.cell).cid))return 0;let s=this.cover(e||t.cell);if(-1==s)return 0;let a=this.gun.accuracy,n=t.def;return Math.round(a-20*s-n-this.gun.accuracyPenalty(this.dist(t)))}die(){this.terrain.units=this.terrain.units.filter(t=>t.hp>0),delete this.cell.unit,0==this.team.units.length&&this.terrain.declareVictory(this.team.enemy)}takeDamage(t){this.hp=Math.max(0,this.hp-t),this.hp<=0&&this.die(),this.onChange()}onChange(){this.terrain.animate({char:this})}shoot(t){return n(this,void 0,void 0,function*(){if(!t)return!1;let e=t.unit;if(!e)return!1;let i=this.hitChance(e);if(0==i)return!1;let s=this.terrain.rni()%100<i;this.ap=0;let a=0;return s&&(a=this.gun.damageRoll(this,e,this.terrain.rnf)),yield this.animateShoot(e.cid,a),e.takeDamage(a),e.hp<=0&&this.team.calculate(),!0})}teleport(t){this.cell.cid!=t.cid&&(delete this.cell.unit,this.cid=t.cid,this.cell.unit=this,this.calculate())}move(t){return n(this,void 0,void 0,function*(){if(t==this.cell||!t)return!1;this.ap-=this.apCost(t);let i=this.pathTo(t),s=this.team.enemy.units,a=[];for(let t of s){if(0==t.ap)continue;let s=e(i,e=>!e.unit&&t.averageDamage(this,e,!0));s&&s.val>=1&&(console.log(s.val),a.push({moment:s.ind,enemy:t}))}a=a.sort((t,e)=>t.moment>e.moment?1:-1);for(let t of a){let e=i[t.moment];if(yield this.animateWalk(this.pathTo(e)),this.teleport(e),yield t.enemy.shoot(e),!this.alive)return!0}return yield this.animateWalk(this.pathTo(t)),this.teleport(t),this.cell.goody&&(this.hp=this.maxHP,this.cell.goody=0),!0})}animateWalk(t){return n(this,void 0,void 0,function*(){t.length<=1||(yield this.terrain.animate({anim:"walk",char:this,path:t}))})}animateShoot(t,e){return n(this,void 0,void 0,function*(){yield this.terrain.animate({anim:"shoot",from:this.cid,to:t,damage:e})})}canDamage(t){return t&&this.team!=t.team&&this.cell.xfov.has(t.cid)&&this.canShoot()}bestPosition(){let t=this.team;this.calculate();let e,i=-100;for(let s in this.dists){let n=this.dists[s][0];if(n>this.speed*this.ap)continue;let r=t.strength[s]-t.weakness[s]-.5*a(n,this.speed)-.001*n;this.kind==v.ASSAULT&&(r-=.1*t.distance[s]),this.kind==v.SNIPER&&(r+=.1*t.distance[s]),r>i&&(i=r,e=Number(s))}return this.terrain.cells[e]}averageDamage(t,e,i=!1){return this.hitChance(t,e,i)*this.gun.averageDamage(this,t,e)/100}bestTarget(){let t=-100,e=null;for(let i of this.terrain.units){if(i.team==this.team||i.hp<=0)continue;let s=this.averageDamage(i);s>t&&(t=s,e=i.cell)}return e}think(){return n(this,void 0,void 0,function*(){yield this.move(this.bestPosition()),this.ap>0&&(yield this.shoot(this.bestTarget()))})}dist(t){return o(this.at,t.at)}info(){let t=[,"gunner","assault","sniper"][this.kind];return`${t.toUpperCase()} <b>${this.hp}HP</b> ${m[t]}`}get alive(){return this.hp>0}friendly(t){return t&&this.team==t.team}}v.EYE=-1,v.GUNNER=1,v.ASSAULT=2,v.SNIPER=3,v.RECON=4,v.MEDIC=5,v.HEAVY=6,v.COMMANDER=7,v.letters="`gasrmhc".split("");class p{constructor(t,e){var i;this.terrainString=t,this.animate=e,this.aiTurn=!1,this.rni=(i=1,(i%=2147483647)<=0&&(i+=2147483646),()=>i=16807*i%2147483647),this.rnf=(()=>this.rni()%1e9/1e9),this.init(t)}init(t){let e=t.split("\n").map(t=>t.trim()).filter(t=>t.length>0);this.h=e.length,this.w=Math.max(...e.map(t=>t.length)),this.cells=[],this.units=[],this.teams=[];for(let t=0;t<2;t++){let e=new g(this,t);this.teams[t]=e}for(let t=0;t<this.h;t++){delete this.victor;let i=e[t];for(let e=0;e<this.w;e++){let s=e+t*this.w,a=i[e]||" ",n=new u(this,s,["+","#"].indexOf(a)+1,v.from(this,a,this.cid(e,t)));"*"==a&&(n.goody=1),"~"==a&&(n.hole=!0),this.cells[s]=n}}for(let t=0;t<this.w;t++)this.seal(t,0),this.seal(t,this.h-1);for(let t=0;t<this.h;t++)this.seal(0,t),this.seal(this.w-1,t);this.dir8Deltas=p.dirs8.map(t=>t[0]+t[1]*this.w);for(let t of this.cells)t.obstacle||t.calculatePovAnCover();for(let t of this.cells)t.obstacle||(t.calculatePovAnCover(),t.calculateFov());for(let t of this.cells)t.obstacle||(t.calculateXFov(),t.calculateDFov())}seal(t,e){this.cells[this.cid(t,e)].seal()}calcDists(t){let e=this.cells.map(t=>[Number.MAX_VALUE,-1]);e[t]=[0,-1];let i=[t],s=this.cells[t].unit;for(;i.length>0;){let t=i.shift(),a=e[t][0],n=this.cells[t];for(let r=0;r<8;r++){let h=r%2,l=this.dir8Deltas[r]+t,o=this.cells[l];if(!o.passable||o.unit&&!o.unit.friendly(s))continue;if(h&&(this.cells[t+this.dir8Deltas[(r+1)%8]].obstacle||this.cells[t+this.dir8Deltas[(r+7)%8]].obstacle))continue;let c=o.obstacle+n.obstacle+(n.unit?1:0)+(o.unit?1:0);if(c>1&&h&&c>0)continue;let d=c+(h?1.414:1);e[l][0]>a+d&&(e[l]=[a+d,t],i.push(l))}}for(let t=0;t<e.length;t++)this.cells[t].standable||(e[t][0]=Number.MAX_VALUE);return e}cid(t,e){return t+e*this.w}cellAt(t,e){return this.cells[this.cid(t,e)]}fromCid(t){return[t%this.w,a(t,this.w)]}calculateFov(t){let[e,i]=this.fromCid(t),s=new Set;return d(e,i,(t,e)=>!this.cellAt(t,e).opaque,(t,e)=>{for(let i of this.cells[this.cid(t,e)].peeked)s.add(i.cid)}),s}calculateDirectFov(t){let[e,i]=this.fromCid(t),s=new Set;return d(e,i,(t,e)=>!this.cellAt(t,e).opaque,(t,e)=>{s.add(this.cid(t,e))}),s}obstacles(t){let e=[];for(let i=0;i<8;i+=2){let s=t+this.dir8Deltas[i];e.push(this.cells[s].obstacle)}return e}cover(t,e){if(!t.xfov.has(e.cid))return-1;let i=2;for(let n of t.povs){let t=0,r=h(e.at,n.at);for(let i=0;i<4;i++){let n=e.cover[i];n<=t||(s=p.dirs8[2*i],a=r,s[0]*a[0]+s[1]*a[1])<-.001&&(t=n)}t<i&&(i=t)}var s,a;return i}declareVictory(t){this.victor=t}get we(){return this.teams[g.BLUE]}}p.dirs8=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];const y=24;class C{constructor(t,e,i,s,a=[0,0]){this.text=t,this.color=e,this.lifeTime=i,this.at=s,this.vel=a,this.time=0}update(t){return this.time+=t,this.at=r(this.at,this.vel,t),this.time<this.lifeTime}render(t){t.save(),t.fillStyle=this.color,t.shadowColor="black",t.shadowBlur=1,t.shadowOffsetX=1,t.shadowOffsetY=1,t.font='12pt "Courier"',t.textAlign="center";let e=0,i=0;for(let s of this.text.split("|"))t.fillText(s.trim().substr(0,Math.floor(70*this.time)-i),this.at[0],this.at[1]+e),i+=s.length,e+=20;t.restore()}}class b{constructor(t,e){this.unit=t,this.at=e.cidToScreen(t.cid)}}class w{constructor(t,e){this.game=t,this.canvas=e,this.canvasCacheOutdated=!1,this.anim=[],this.animQueue=[],this.dolls=[],this.dollCache={},this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight}synch(){this.dolls=this.terrain.units.map(t=>new b(t,this)),this.updateCanvasCache()}get terrain(){return this.game.terrain}update(t){let e=this.anim;this.anim=[],e=e.filter(e=>e.update(t)),this.anim=this.anim.concat(e),this.animQueue.length>0&&!this.animQueue[0].update(t)&&this.animQueue.shift(),0==this.animQueue.length&&this.blockingAnimationEnd&&(this.blockingAnimationEnd(),delete this.blockingAnimationEnd),this.dolls=this.dolls.filter(t=>t.unit.alive)}render(t){t.clearRect(0,0,this.width,this.height);let e=this.terrain;this.canvasCache&&!this.canvasCacheOutdated||this.updateCanvasCache(),t.clearRect(0,0,e.w*y,e.h*y),t.save(),t.drawImage(this.canvasCache,0,0),t.restore();for(let e of this.dolls)this.renderDoll(t,e);for(let e of this.anim)e.render&&e.render(t);return this.animQueue.length>0&&this.animQueue[0].render&&this.animQueue[0].render(t),this.busy||this.renderPath(t,this.game.hoveredCell),this.animQueue.length>0}renderPath(t,e){let i=this.game.chosen;if(!(i&&e&&i.dists&&i.dists[e.cid]&&-1!=i.dists[e.cid][1]))return;if(!i.reachable(e))return;let s=this.cidToCenter(e.cid);t.beginPath(),i.reachable(e)?t.arc(s[0],s[1],y/4,0,2*Math.PI):(t.moveTo(s[0]-y/4,s[1]-y/4),t.lineTo(s[0]+y/4,s[1]+y/4),t.stroke(),t.beginPath(),t.moveTo(s[0]-y/4,s[1]+y/4),t.lineTo(s[0]+y/4,s[1]-y/4)),t.stroke();let a=i.pathTo(e);t.beginPath(),t.moveTo(...this.cidToCenter(a[0].cid));for(let e of a)t.lineTo(...this.cidToCenter(e.cid));t.stroke()}renderThreats(t,e){let i=this.terrain,s=e.cid;i.teams[g.RED].strength&&(t.strokeStyle="#800",t.lineWidth=4==i.teams[g.RED].strength[s]?3:1,t.beginPath(),t.moveTo(3.5,3.5),t.lineTo(3.5,3.5+3*i.teams[g.RED].strength[s]),t.stroke(),t.strokeStyle="#008",t.lineWidth=4==i.teams[g.RED].weakness[s]?3:1,t.beginPath(),t.moveTo(3.5,3.5),t.lineTo(3.5+3*i.teams[g.RED].weakness[s],3.5),t.stroke())}renderCell(t,e){let i=this.cidToScreen(e.cid),s=[,w.lowTile,w.highTile][e.obstacle];e.hole&&(s=w.waterTile),s&&t.drawImage(s,i[0],i[1])}renderCellUI(t,e){let i=this.cidToScreen(e.cid),s=this.game;if(t.strokeStyle="#000",t.lineWidth=2,s.hoveredCell){let a=s.hoveredCell.xfov.has(e.cid);s.hoveredCell.rfov.has(e.cid)||(t.fillStyle=`rgba(${a?"50,50,0,0.04":"0,0,50,0.1"})`,t.fillRect(i[0],i[1],y,y))}if(s.chosen&&s.chosen.dists&&!this.busy){let a=s.chosen.apCost(e);if(a>0&&a<=s.chosen.ap){let e=[,w.ap1Sprite,w.ap2Sprite][Math.floor(a)];e&&t.drawImage(e,i[0],i[1])}}var a,n;e.povs&&e.peeked.includes(this.game.hoveredCell)&&(t.strokeStyle="rgba(0,0,0,0.5)",t.lineWidth=.5,t.beginPath(),t.arc(i[0]+y/2,i[1]+y/2,y/4,0,2*Math.PI),t.stroke()),e.goody&&(t.translate(...i),t.fillStyle="#080",t.fillRect(.35*y,0,.3*y,y),t.fillRect(0,.35*y,y,.3*y),t.translate(...(a=i,n=-1,[a[0]*n,a[1]*n])))}renderDoll(t,e){t.save(),t.translate(...e.at),this.useDollCache(t,e),e.unit==this.game.chosen?this.outline(t,e,Math.sin((new Date).getTime()/100)+1):e.unit==this.game.hoveredChar&&this.outline(t,e,1.5),t.restore()}outline(t,e,i=2){t.save(),t.strokeStyle=e.unit.strokeColor,t.lineWidth=i,t.beginPath(),t.arc(y/2,y/2,.4*y,0,2*Math.PI),t.stroke(),t.restore()}useDollCache(t,e){let i=e.unit,a=["cid","hp","ap","kind","faction"].map(t=>i[t]);a.push(this.dollTint(e));let n=a.join(",");n in this.dollCache||(this.dollCache[n]=s([y,y],t=>this.renderDollBody(t,e,this.dollTint(e)))),t.drawImage(this.dollCache[n],0,0)}dollTint(t){if(this.busy||this.terrain.aiTurn)return 0;let e=t.unit,i=0,s=this.game.hoveredCell;if(s&&s.xfov){i=s.xfov.has(e.cid)||e.team==this.game.lastSelectedFaction?(0==this.terrain.cover(e.cell,s)?1:0)+(0==this.terrain.cover(s,e.cell)?2:0):4}return this.game.hoveredCell||(i=0),i}renderDollBody(t,e,i){let s=e.unit;t.fillStyle=["#fff","#fba","#cfa","#ffa","#ccc"][i],t.strokeStyle=s.strokeColor,t.shadowColor="#444",t.shadowOffsetX=1,t.shadowOffsetY=1,t.shadowBlur=4,t.beginPath(),t.arc(.5*y,.5*y,.4*y,0,2*Math.PI),t.fill(),t.shadowColor="rgba(0,0,0,0)",t.lineWidth=2;for(let e=0;e<s.hp;e++){let i=Math.PI*(1-e/(s.maxHP-1)),n=(a=i,[Math.cos(a),Math.sin(a)]);t.beginPath(),t.moveTo((.5+.4*n[0])*y,(.5+.4*n[1])*y),t.lineTo((.5+.5*n[0])*y,(.5+.5*n[1])*y),t.stroke()}var a;t.lineWidth=1,t.fillStyle=s.strokeColor,t.textAlign="center",t.font=`bold ${y/2}pt Courier`,t.fillText(v.letters[s.kind].toUpperCase(),.5*y,.66*y),t.stroke(),s.ap>0&&(t.fillStyle=e.unit.strokeColor,t.beginPath(),t.moveTo(1,1),t.lineTo(6,1),t.lineTo(1,6),t.closePath(),t.fill(),s.ap>1&&(t.beginPath(),t.moveTo(y-1,1),t.lineTo(y-6,1),t.lineTo(+y-1,6),t.closePath(),t.fill()))}cidToScreen(t){return this.terrain.fromCid(t).map(t=>t*y)}cidToCenter(t){return this.terrain.fromCid(t).map(t=>(t+.5)*y)}cidScreen(t,e){return this.terrain.cid(a(t,y),a(e,y))}cellAtScreen(t,e){return this.terrain.cells[this.cidScreen(t,e)]}get animationSpeed(){return this.terrain.aiTurn,.5}updateCanvasCache(){this.canvasCache||(this.canvasCache=i(this.terrain.w*y,this.terrain.h*y)),this.canvasTerrain||(this.canvasTerrain=i(this.terrain.w*y,this.terrain.h*y));let t=this.canvasTerrain.getContext("2d");t.clearRect(0,0,this.terrain.w*y,this.terrain.h*y);for(let e=0;e<this.terrain.cells.length;e++){let i=this.terrain.cells[e];this.renderCell(t,i)}let e=this.canvasCache.getContext("2d");e.clearRect(0,0,this.terrain.w*y,this.terrain.h*y),e.save(),e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=1,e.shadowColor="#444",e.drawImage(this.canvasTerrain,0,0),e.restore();for(let t=0;t<this.terrain.cells.length;t++){let i=this.terrain.cells[t];this.renderCellUI(e,i)}this.canvasCacheOutdated=!1}resetCanvasCache(){this.canvasCacheOutdated=!0}text(t,e){let i=r(t,[0,-10]);this.anim.push(new C(e,"#f00",3,i,[0,-10]))}renderBullet(t,[e,i],s){t.beginPath();let a=function(t,e=1){let i=l(t)||1;return[t[0]/i*e,t[1]/i*e]}(h(i,e),-20),n=c(e,i,s),o=r(n,a);var d=t.createLinearGradient(o[0],o[1],n[0],n[1]);d.addColorStop(0,"rgba(0,0,0,0)"),d.addColorStop(1,"rgba(0,0,0,1)"),t.lineWidth=4,t.strokeStyle=d,t.moveTo(...o),t.lineTo(...n),t.stroke(),t.lineWidth=1,t.strokeStyle="#000"}shoot(t,e,i){let s,a,n,r=[t,e].map(t=>this.terrain.cells[t]);t:for(a of r[0].povs)for(n of r[1].povs)if(a.rfov.has(n.cid)){s=[a,n].map(t=>this.cidToCenter(t.cid));break t}let l=this.dollAt(t),d=this.dollAt(e),u=0;a.cid==t&&n.cid==e&&(u=1),this.animQueue.push({update:a=>{if(u<1||u>2){let i=.6*(u<1?u:3-u);for(let a=0;a<2;a++){[l,d][a].at=c(this.cidToScreen([t,e][a]),h(s[a],[y/2,y/2]),i)}u+=a*this.animationSpeed*10}else u+=a*Math.min(10,1e3/o(...s)*this.animationSpeed);return!(u>3)||(this.text(s[1],i>0?`-${i}`:"MISS"),l.at=this.cidToScreen(l.unit.cid),d.at=this.cidToScreen(d.unit.cid),!1)},render:t=>{u>1&&u<2&&this.renderBullet(t,s,u-1)}})}walk(t,e){let i=e.map(t=>this.cidToScreen(t.cid)),s=0;this.animQueue.push({update:e=>(s+=15*e*this.animationSpeed,i[Math.floor(s)+1]?(t.at=c(i[Math.floor(s)],i[Math.floor(s)+1],s-Math.floor(s)),!0):(t.at=i[i.length-1],!1))})}dollOf(t){return this.dolls.find(e=>e.unit==t)}dollAt(t){return this.dolls.find(e=>e.unit.cid==t)}draw(t){return n(this,void 0,void 0,function*(){switch(t.anim){case"walk":this.walk(this.dollOf(t.char),t.path);break;case"shoot":this.shoot(t.from,t.to,t.damage)}yield this.waitForAnim()})}waitForAnim(){return new Promise(t=>{this.blockingAnimationEnd=(()=>t())})}get busy(){return this.animQueue.length>0}}w.ap1Sprite=s([y,y],t=>{t.strokeStyle="#555",t.strokeRect(4.5,4.5,y-8,y-8)}),w.ap2Sprite=s([y,y],t=>{t.strokeStyle="#bbb",t.strokeRect(4.5,4.5,y-8,y-8)}),w.hiddenSprite=s([y,y],t=>{t.fillStyle="rgba(0,0,0,0.12)",t.fillRect(0,0,y,y)}),w.dashPattern=s([4,4],t=>{for(let e=0;e<4;e++)t.fillRect(e,e,1,1)}),w.wavePattern=s([12,12],t=>{t.beginPath(),t.arc(6.5,4,7,7,Math.PI),t.stroke()}),w.crossPattern=s([3,3],t=>{for(let e=0;e<4;e++)t.fillRect(4-e-1,e,1,1),t.fillRect(e,e,1,1)}),w.highTile=s([y,y],t=>{t.fillStyle="#000",t.fillRect(0,0,y,y)}),w.lowTile=s([y,y],t=>{t.fillStyle="#fff",t.fillRect(0,0,y,y),t.fillStyle=t.createPattern(w.dashPattern,"repeat"),t.fillRect(0,0,y,y)}),w.waterTile=s([y,y],t=>{t.fillStyle=t.createPattern(w.wavePattern,"repeat"),t.fillRect(0,0,y,y)});class P{constructor(t,e,i){this.canvas=t,this.updateUI=e,this.time=0,this.mode=P.PAI,this.ctx=t.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.tooltip=document.getElementById("tooltip"),this.info=document.getElementById("info"),this.canvas.height=this.canvas.clientHeight,this.canvas.width=this.canvas.clientWidth,this.renderer=new w(this,this.canvas),this.init(i)}init(t){t||(t="\n      ##################################################\n      ################# g+         ###++    ##      ++##\n      ################# ++         +                 +##\n      ####################               a+          +##\n      #################                   +    +      ##\n      #################* #          ++++      ##      ##\n      ####################                     +      ##\n      #################        +# + #+a##     g#   ++g##\n      ##################+##  ####################  +####\n      ###   +++  #*+  # g#   a###################      #\n      ###       a#   +# +#    ##########+#++++  #   # *#\n      #   +      ###  #  #    #        # a+++   #   ####\n      #  g+        #  #+ #       +  +  #              ##\n      #   +        ## ## #      g+  +     +           ##\n      #                  #  g #        #+  +++  #     ##\n      #    + ## ####  #     ++#  +  +  #a  +#+  #     ##\n      #    + g# +###  ####    #######  ##########     ##\n      #++  + ## ##a+  +  #   +##+a+     + #  +  ##+   ##\n      #       # +#       #++ +# + +   +g+ # ++ +#+    ##\n      #       # +#   +   #+         +++               ##\n      #   #++## +## #+# ##            +               ##\n      #   +         +         #         ++      #     ##\n      #                  #    # ####### ### ## ### +  ##\n      #   #  a+          #g   # a*##++a     #+  #  +  ##\n      #~~~~~~~~~ ~~~~~~####  ##################### +  ##\n      #~~~~~~~~# #~~~~~~##    a+#+ +                  ##\n      #~~~~~~~~ *              +     # ##          AGA##\n      ###~~~~~~# #~~~~~~~~           #  #          GGA##\n      ####~~~~~~~~~~~~~~~#           # *#          AAA##\n      ##################################################\n      "),this.terrain=new p(t,t=>this.renderer.draw(t)),this.renderer.synch()}over(){return!1}update(t){this.lastLoopTimeStamp||(this.lastLoopTimeStamp=t-.001);let e=Math.min(.02,(t-this.lastLoopTimeStamp)/1e3);this.lastLoopTimeStamp=t,this.time+=e,this.renderer.update(e),this.renderer.render(this.ctx),this.over()&&this.updateUI(),this.chosen&&!this.chosen.alive&&delete this.chosen}updateTooltip(t,e){this.tooltip.style.display=t?"block":"none",t&&(this.tooltip.style.left=(t[0]+30+this.canvas.offsetLeft).toString(),this.tooltip.style.top=t[1].toString(),this.tooltip.innerHTML=e)}updateInfo(t){this.info.innerHTML=t||(this.terrain.victor?`<H3 style="color:white; background:${this.terrain.victor.color}">${this.terrain.victor.name} side victorious</H3>`:"")}click(t,e){let i=this.renderer.cellAtScreen(t,e);this.clickCell(i),this.renderer.resetCanvasCache()}canPlayAs(t){return t.blue||this.mode!=P.PAI}clickCell(t){if(t){if(t.unit){if(this.chosen&&this.chosen.team==t.unit.team&&this.canPlayAs(t.unit))return this.chosen=t.unit,void this.chosen.calculate();if(this.chosen&&this.chosen.canDamage(t.unit))return void this.chosen.shoot(t);this.chosen==t.unit?this.cancel():this.canPlayAs(t.unit)&&(this.chosen=t.unit),this.chosen&&this.chosen.calculate()}!t.unit&&this.chosen&&this.chosen.reachable(t)&&(this.chosen.move(t),this.terrain.teams[g.RED].calculate()),this.lastSelectedFaction=this.chosen?this.chosen.team:this.terrain.we}}cancel(){delete this.chosen,this.renderer.resetCanvasCache()}hover(t,e){let i=this.renderer.cellAtScreen(t,e);if(this.hoveredCell==i)return;if(!i)return delete this.hoveredCell,void this.renderer.resetCanvasCache();if(!i)return;this.hoveredCell=i;let s="default";(this.chosen&&this.chosen.reachable(i)||i.unit)&&(s="pointer"),this.chosen&&this.chosen.canDamage(i.unit)?(s="crosshair",this.updateTooltip(this.renderer.cidToCenter(i.cid),`${this.chosen.hitChance(i.unit)}% ${this.chosen.gun.averageDamage(this.chosen,i.unit).toFixed(1)}`)):this.updateTooltip(),document.body.style.cursor=s,i.unit?this.updateInfo(i.unit.info()):this.updateInfo(),this.renderer.busy||this.renderer.resetCanvasCache()}endTurn(){return n(this,void 0,void 0,function*(){delete this.chosen,this.mode==P.AIAI&&(yield this.terrain.teams[g.BLUE].think()),this.mode!=P.PP&&(yield this.terrain.teams[g.RED].think());for(let t of this.terrain.units)t.ap=2;this.renderer.resetCanvasCache()})}toggleMode(){return this.mode=(this.mode+1)%3,["[P+AI] 2P 2AI","P+AI [2P] 2AI","P+AI 2P [2AI]"][this.mode]}setMode(t){this.mode=t}get hoveredChar(){if(this.hoveredCell)return this.hoveredCell.unit}}let S,x;P.PAI=0,P.PP=1,P.AIAI=2;let k,T,A,E,R,M=0,D=0;function I(t){(x=t)||S.getContext("2d").clearRect(0,0,1200,1200)}function O(){I(x)}function L(){for(let t=0;t<3;t++)t==D?T[t].classList.add("pressed"):T[t].classList.remove("pressed");for(let t=0;t<3;t++)t==M?(k[t].classList.add("pressed"),A[t].style.display="block"):(k[t].classList.remove("pressed"),A[t].style.display="none");R.innerHTML=0==M?"End Turn":"Apply",R.style.visibility=1==M?"hidden":"visible"}return window.onload=function(){S=document.getElementById("main"),R=document.getElementById("endb"),A=["main","help","editor"].map(t=>document.getElementById(t)),k=["playb","helpb","editb"].map(t=>document.getElementById(t));for(let t=0;t<3;t++)k[t].onclick=(e=>{M=t,L()});T=["pai","pp","aiai"].map(t=>document.getElementById(t));for(let t=0;t<3;t++)T[t].onclick=(e=>{D=t,x.setMode(D),L()});L(),I(new P(S,O)),R.onclick=(t=>{0==M&&x.endTurn(),2==M&&(x.init(E.value),M=0,L())}),E=document.getElementById("edit-area"),S.addEventListener("mousedown",t=>{2==t.button?(console.log(x.terrain),x.cancel()):x.click(t.offsetX,t.offsetY)}),S.addEventListener("mousemove",t=>{x.hover(t.offsetX,t.offsetY)}),S.addEventListener("mouseleave",t=>{x.hover(void 0,void 0)}),S.addEventListener("mouseenter",t=>{}),S.addEventListener("contextmenu",function(t){t.preventDefault()},!1),document.addEventListener("keyup",t=>{}),document.addEventListener("keydown",t=>{}),function t(e){requestAnimationFrame(i=>{e(i),t(e)})}(t=>{x&&!x.over()&&x.update(t),0==M&&(R.style.visibility=x.renderer.busy?"hidden":"visible")}),I(x),console.log(x.terrain.terrainString),E.value=x.terrain.terrainString},t.mouseAt=void 0,t}({});
