var app=function(t){"use strict";function e(t,e){let i=function(t,e){let i=Number.MAX_VALUE,s=-1;for(let n=0;n<t.length;n++){let a=e(t[n]);i>a&&(i=a,s=n)}if(s>=0)return{ind:s,item:t[s],val:i}}(t,t=>-e(t));if(i)return i.val=-i.val,i}function i(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,i}function s(t,e){const s=i(...t),n=s.getContext("2d");return n.lineWidth=1,n.strokeStyle="#000",e(n),s}function n(t,e){return Math.floor(t/e)}function a(t,e,i,s){return new(i||(i=Promise))(function(n,a){function r(t){try{l(s.next(t))}catch(t){a(t)}}function o(t){try{l(s.throw(t))}catch(t){a(t)}}function l(t){t.done?n(t.value):new i(function(e){e(t.value)}).then(r,o)}l((s=s.apply(t,e||[])).next())})}function r(t,e,i=1){return[t[0]+e[0]*i,t[1]+e[1]*i]}function o(t,e){return[t[0]-e[0],t[1]-e[1]]}function l(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function h(t,e){return l([t[0]-e[0],t[1]-e[1]])}function c(t,e){return[t[0]*e,t[1]*e]}function d(t,e,i){return[t[0]*(1-i)+i*e[0],t[1]*(1-i)+i*e[1]]}function u(t,e,i,s){var n=function(a,r,o,l){if(!(r>=o)){for(var h=Math.round((a-.5)*r),c=Math.ceil((a+.5)*o-.5),d=h;d<=c;d++){var u=t+l.xx*d+l.xy*a,p=e+l.yx*d+l.yy*a;if(i(u,p))d>=a*r&&d<=a*o&&s(u,p);else if(d>=(a-.5)*r&&d-.5<=a*o&&s(u,p),n(a+1,r,(d-.5)/a,l),(r=(d+.5)/a)>=o)return}n(a+1,r,o,l)}},a=[{xx:1,xy:0,yx:0,yy:1},{xx:1,xy:0,yx:0,yy:-1},{xx:-1,xy:0,yx:0,yy:1},{xx:-1,xy:0,yx:0,yy:-1},{xx:0,xy:1,yx:1,yy:0},{xx:0,xy:1,yx:-1,yy:0},{xx:0,xy:-1,yx:1,yy:0},{xx:0,xy:-1,yx:-1,yy:0}];s(t,e);for(var r=0;r<8;r++)n(1,0,1,a[r])}class p{constructor(t,e,i,s){this.terrain=t,this.cid=e,this.obstacle=i,this.unit=s,this.rfov=new Set,this.xfov=new Set,this.dfov=new Set,this.povs=[],this.peeked=[]}calculatePovAnCover(){this.obstacle||(this.cover=this.terrain.obstacles(this.cid),this.calculatePovs())}calculateFov(){if(this.opaque)return;let t=this.terrain,[e,i]=this.at,s=new Set;u(e,i,(e,i)=>!t.cellAt(e,i).opaque,(e,i)=>{s.add(t.cid(e,i))}),this.rfov=s}calculateXFov(){let t=new Set;for(let e of this.povs)for(let i of e.rfov){let e=this.terrain.cells[i];for(let i of e.peeked)t.add(i.cid)}this.xfov=t}calculateDFov(){let t=new Set;for(let e of this.povs)for(let i of e.rfov)t.add(i);this.dfov=t}get at(){return this.terrain.fromCid(this.cid)}dist(t){return h(this.at,t.at)}seal(){this.obstacle=2,delete this.unit,this.goody=0}get opaque(){return 2==this.obstacle}get passable(){return this.obstacle<2&&!this.hole}get standable(){return 0==this.obstacle&&!this.hole&&!this.unit}calculatePovs(){this.povs=[];let t=this.terrain,e=this.cid;this.povs.push(this);for(let i=0;i<8;i+=2){let s=e+t.dir8Deltas[i];if(!t.cells[s].obstacle)continue;let n=[e+t.dir8Deltas[(i+6)%8],e+t.dir8Deltas[(i+7)%8]],a=[e+t.dir8Deltas[(i+2)%8],e+t.dir8Deltas[(i+1)%8]];for(let e of[n,a]){t.cells[e[0]].standable&&t.cells[e[1]].obstacle<=1&&this.povs.push(t.cells[e[0]])}}for(let t of this.povs)t.peeked.push(this)}}class m{constructor(t){this.damageOptimalRange=[1,20],this.damage=[4,5],this.damagePenaltyPerCell=100,this.accuracyPenaltyMax=20,this.accuracy=60,this.accuracyOptimalRange=[1,1],this.accuracyPenaltyPerCell=1,this.damagePenaltyMax=2,this.breach=0,this.name="Gun",t&&Object.assign(this,t)}damagePenalty(t){let e=0;return t<this.damageOptimalRange[0]&&(e=this.damageOptimalRange[0]-t),t>this.damageOptimalRange[1]&&(e=t-this.damageOptimalRange[1]),Math.min(this.damagePenaltyMax,this.damagePenaltyPerCell*e)}accuracyPenalty(t){let e=0;return t<this.accuracyOptimalRange[0]&&(e=this.accuracyOptimalRange[0]-t),t>this.accuracyOptimalRange[1]&&(e=t-this.accuracyOptimalRange[1]),Math.min(this.accuracyPenaltyMax,this.accuracyPenaltyPerCell*e)}averageDamage(t,e,i){i||(i=e.cell);let s=.5*(this.damage[1]+this.damage[0]);return s-=Math.max(0,e.armor-this.breach),s-=this.damagePenalty(t.dist(i)),Math.max(0,Math.round(10*s)/10)}damageRoll(t,e,i){let s=i()*(this.damage[1]-this.damage[0])+this.damage[0];return s-=Math.max(0,e.armor-this.breach),s-=this.damagePenalty(t.dist(e)),Math.max(0,Math.round(s))}}var f=Object.freeze({Sharpshooter:"\nHits accurately and hard at long range, regardless of target's armor.\nHas extra defence, making him nearly untouchable when in cover. \nPretty helpess up close and has low HP.\n",Assault:"\nPsycho with a shotgun. \nFast and even has a bit of armor to survive close quater fight a bit longer.\nCan deal a lot of damage, but only up close.\n",Gunner:"\nEffective in any range and has extra hp.\nQuite slow.\n"});class g{constructor(t,e){this.terrain=t,this.faction=e,this.fov=new Set}serialize(){return{units:this.units.map(t=>t.serialize())}}calculate(){this.strength=[],this.weakness=[],this.distance=[];let t=this.terrain;this.fov.clear();for(let t of this.units)for(let e of t.cell.xfov)this.fov.add(e);let e=this.terrain.teams[1-this.faction];for(let i of this.fov){let s=this.terrain.cells[i];for(let n of e.units){let e=n.cell,a=(4-t.cover(s,e))%5;this.strength[i]>a||(this.strength[i]=a);let r=(4-t.cover(e,s))%5;if(this.weakness[i]>r||(this.weakness[i]=r),a>0||r>0){let t=s.dist(e);this.distance[i]<=t||(this.distance[i]=t)}}}}aiTurn(){return a(this,void 0,void 0,function*(){this.terrain.aiTurn=!0,this.calculate();for(let t of this.terrain.units)t.team==this&&(yield t.think());this.terrain.aiTurn=!1})}beginTurn(){for(let t of this.units)t.ap=2;this.terrain.activeTeam=this.faction}get units(){return this.terrain.units.filter(t=>t.team==this)}get enemy(){return this.terrain.teams[1-this.faction]}get name(){return["RED","BLUE"][this.faction]}get color(){return["RED","BLUE"][this.faction]}}g.RED=0,g.BLUE=1;class v{constructor(t,e,i,s,n=new m){this.terrain=t,this.config=e,this.team=i,this.cid=s,this.gun=n,this.speed=5,this.maxHP=10,this.hp=this.maxHP,this.ap=2,this.armor=0,this.sight=20,this.def=0,this.aggression=0,this.name="dude",this.symbol="d",t.units.push(this),Object.assign(this,e),this.hp=this.maxHP,this.gun=t.campaign.guns[e.gun]}serialize(){return{hp:this.hp,ap:this.ap,cid:this.cid,symbol:this.symbol}}static from(t,e){let i=e.symbol,s=e.cid,n=t.teams[i.toUpperCase()==i?g.BLUE:g.RED],a=t.campaign.units[i.toLowerCase()];if(!a)return;a.symbol=i.toLowerCase();let r=new v(t,a,n,s);return Object.assign(r,e),t.cells[r.cid]&&(t.cells[r.cid].unit=r),r}get blue(){return this.team==this.terrain.we}pathTo(t){let e=t.cid,i=[e];for(;!((e=this.dists[e][1])<0);)i.push(e);return i.reverse().map(t=>this.terrain.cells[t])}get strokeColor(){return this.blue?"#00a":"#a00"}get x(){return this.cid%this.terrain.w}get y(){return n(this.cid,this.terrain.w)}get cell(){return this.terrain.cells[this.cid]}reachable(t){return this.apCost(t)<=this.ap}calculateDists(){this.dists=this.terrain.calcDists(this.cid)}calculate(){this.calculateDists()}cover(t){return this.terrain.cover(this.cell,t)}get at(){return this.terrain.fromCid(this.cid)}apCost(t){if(!this.dists)return Number.MAX_VALUE;let e=this.dists[t.cid][0];return Math.ceil(e/this.speed)}canShoot(){return this.ap>0}hitChance(t,e,i=!1){if(!(i?this.cell.dfov:this.cell.xfov).has((e||t.cell).cid))return 0;let s=this.cover(e||t.cell);if(-1==s)return 0;let n=this.gun.accuracy,a=t.def;return Math.round(n-25*s-a-this.gun.accuracyPenalty(this.dist(t)))}die(){this.terrain.units=this.terrain.units.filter(t=>t.hp>0),delete this.cell.unit,0==this.team.units.length&&this.terrain.declareVictory(this.team.enemy)}takeDamage(t){this.hp=Math.max(0,this.hp-t),this.hp<=0&&this.die(),this.onChange()}onChange(){this.terrain.animate({char:this})}shoot(t){return a(this,void 0,void 0,function*(){if(!t)return!1;let e=t.unit;if(!e)return!1;let i=this.hitChance(e);if(0==i)return!1;let s=this.terrain.rni()%100<i;this.ap=0;let n=0;return s&&(n=this.gun.damageRoll(this,e,this.terrain.rnf)),yield this.animateShoot(e.cid,n),e.takeDamage(n),e.hp<=0&&this.team.calculate(),!0})}teleport(t){this.cell.cid!=t.cid&&(delete this.cell.unit,this.cid=t.cid,this.cell.unit=this,this.calculate())}move(t){return a(this,void 0,void 0,function*(){if(t==this.cell||!t)return!1;this.ap-=this.apCost(t);let i=this.pathTo(t),s=this.team.enemy.units,n=[];for(let t of s){if(0==t.ap)continue;let s=e(i,e=>!e.unit&&t.averageDamage(this,e,!0));s&&s.val>=1&&n.push({moment:s.ind,enemy:t})}n=n.sort((t,e)=>t.moment>e.moment?1:-1);for(let t of n){let e=i[t.moment];if(yield this.animateWalk(this.pathTo(e)),this.teleport(e),yield t.enemy.shoot(e),!this.alive)return!0}return yield this.animateWalk(this.pathTo(t)),this.teleport(t),this.cell.goody&&(this.hp=this.maxHP,this.cell.goody=0),!0})}animateWalk(t){return a(this,void 0,void 0,function*(){t.length<=1||(yield this.terrain.animate({anim:"walk",char:this,path:t}))})}animateShoot(t,e){return a(this,void 0,void 0,function*(){yield this.terrain.animate({anim:"shoot",from:this.cid,to:t,damage:e})})}canDamage(t){return t&&this.team!=t.team&&this.cell.xfov.has(t.cid)&&this.canShoot()}bestPosition(){let t=this.team;this.calculate();let e,i=-100;for(let s in this.dists){let a=this.dists[s][0];if(a>this.speed*this.ap)continue;let r=t.strength[s]-t.weakness[s]-.5*n(a,this.speed)-.001*a;(r+=t.distance[s]*this.aggression)>i&&(i=r,e=Number(s))}return this.terrain.cells[e]}averageDamage(t,e,i=!1){return this.hitChance(t,e,i)*this.gun.averageDamage(this,t,e)/100}bestTarget(){let t=-100,e=null;for(let i of this.terrain.units){if(i.team==this.team||i.hp<=0)continue;let s=this.averageDamage(i);s>t&&(t=s,e=i.cell)}return e}think(){return a(this,void 0,void 0,function*(){yield this.move(this.bestPosition()),this.ap>0&&(yield this.shoot(this.bestTarget()))})}dist(t){return h(this.at,t.at)}info(){return`${this.name.toUpperCase()} <b>${this.hp}HP</b> ${f[this.name]}`}get alive(){return this.hp>0}friendly(t){return t&&this.team==t.team}}v.EYE=-1,v.GUNNER=1,v.ASSAULT=2,v.SNIPER=3,v.RECON=4,v.MEDIC=5,v.HEAVY=6,v.COMMANDER=7;class y{constructor(t,e,i){var s;let n;this.campaign=t,this.animate=i,this.aiTurn=!1,this.rni=(s=1,(s%=2147483647)<=0&&(s+=2147483646),()=>s=16807*s%2147483647),this.activeTeam=0,this.rnf=(()=>this.rni()%1e9/1e9),e&&(n=e.stage),n=n||t.startingStage,this.stage=t.stages.find(t=>t.name==n)||t.stages[0];for(let e in t.guns)t.guns[e]=new m(t.guns[e]);this.init(this.stage.terrain),e&&this.loadState(e)}serialize(){return{campaign:this.campaign.name,stage:this.stage.name,teams:this.teams.map(t=>t.serialize()),activeTeam:this.activeTeam}}init(t){this.terrainString=t;let e=t.split("\n").map(t=>t.trim()).filter(t=>t.length>0);this.h=e.length,this.w=Math.max(...e.map(t=>t.length)),this.cells=[],this.units=[],this.teams=[];for(let t=0;t<2;t++){let e=new g(this,t);this.teams[t]=e}for(let t=0;t<this.h;t++){delete this.victor;let i=e[t];for(let e=0;e<this.w;e++){let s=e+t*this.w,n=i[e]||" ",a=new p(this,s,["+","#"].indexOf(n)+1,v.from(this,{symbol:n,cid:this.cid(e,t)}));"*"==n&&(a.goody=1),"~"==n&&(a.hole=!0),this.cells[s]=a}}for(let t=0;t<this.w;t++)this.seal(t,0),this.seal(t,this.h-1);for(let t=0;t<this.h;t++)this.seal(0,t),this.seal(this.w-1,t);this.dir8Deltas=y.dirs8.map(t=>t[0]+t[1]*this.w);for(let t of this.cells)t.obstacle||t.calculatePovAnCover();for(let t of this.cells)t.obstacle||(t.calculatePovAnCover(),t.calculateFov());for(let t of this.cells)t.obstacle||(t.calculateXFov(),t.calculateDFov());console.log(this)}seal(t,e){this.cells[this.cid(t,e)].seal()}loadState(t){t.terrain&&t.terrain.teams&&(this.units=[],this.cells.forEach(t=>delete t.unit),this.teams=t.terrain.teams.map((t,e)=>{let i=new g(this,e);for(let e of t.units){v.from(this,e).team=i}return i}))}calcDists(t){let e=this.cells.map(t=>[Number.MAX_VALUE,-1]);e[t]=[0,-1];let i=[t],s=this.cells[t].unit;for(;i.length>0;){let t=i.shift(),n=e[t][0],a=this.cells[t];for(let r=0;r<8;r++){let o=r%2,l=this.dir8Deltas[r]+t,h=this.cells[l];if(!h.passable||h.unit&&!h.unit.friendly(s))continue;if(o&&(this.cells[t+this.dir8Deltas[(r+1)%8]].obstacle||this.cells[t+this.dir8Deltas[(r+7)%8]].obstacle))continue;let c=h.obstacle+a.obstacle+(a.unit?1:0)+(h.unit?1:0);if(c>1&&o&&c>0)continue;let d=c+(o?1.414:1);e[l][0]>n+d&&(e[l]=[n+d,t],i.push(l))}}for(let t=0;t<e.length;t++)this.cells[t].standable||(e[t][0]=Number.MAX_VALUE);return e}safeCid(t,e){if(t>=0&&e>=0&&t<this.w&&e<this.h)return this.cid(t,e)}cid(t,e){return t+e*this.w}cellAt(t,e){return this.cells[this.cid(t,e)]}fromCid(t){return[t%this.w,n(t,this.w)]}calculateFov(t){let[e,i]=this.fromCid(t),s=new Set;return u(e,i,(t,e)=>!this.cellAt(t,e).opaque,(t,e)=>{for(let i of this.cells[this.cid(t,e)].peeked)s.add(i.cid)}),s}calculateDirectFov(t){let[e,i]=this.fromCid(t),s=new Set;return u(e,i,(t,e)=>!this.cellAt(t,e).opaque,(t,e)=>{s.add(this.cid(t,e))}),s}obstacles(t){let e=[];for(let i=0;i<8;i+=2){let s=t+this.dir8Deltas[i];e.push(this.cells[s].obstacle)}return e}cover(t,e){if(!t.xfov.has(e.cid))return-1;let i=2;for(let a of t.povs){let t=0,r=o(e.at,a.at);for(let i=0;i<4;i++){let a=e.cover[i];a<=t||(s=y.dirs8[2*i],n=r,s[0]*n[0]+s[1]*n[1])<-.001&&(t=a)}t<i&&(i=t)}var s,n;return i}declareVictory(t){this.victor=t}get we(){return this.teams[g.BLUE]}}y.dirs8=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];class S{constructor(t,e,i,s,n=[0,0]){this.text=t,this.color=e,this.lifeTime=i,this.at=s,this.vel=n,this.time=0}update(t){return this.time+=t,this.at=r(this.at,this.vel,t),this.time<this.lifeTime}render(t){t.save(),t.fillStyle=this.color,t.shadowColor="black",t.shadowBlur=1,t.shadowOffsetX=1,t.shadowOffsetY=1,t.font='12pt "Courier"',t.textAlign="center";let e=0,i=0;for(let s of this.text.split("|"))t.fillText(s.trim().substr(0,Math.floor(70*this.time)-i),this.at[0],this.at[1]+e),i+=s.length,e+=20;t.restore()}}const b=4;class C{constructor(t,e){this.unit=t,this.at=e.cidToPoint(t.cid)}}class P{constructor(t){this.game=t,this.canvasCacheOutdated=!1,this.anim=[],this.animQueue=[],this.dolls=[],this.tileSize=32,this.screenPos=[0,0],this.dollCache={},this.initSprites()}get canvas(){return this.game.canvas}synch(){this.dolls=this.terrain.units.map(t=>new C(t,this)),this.updateCanvasCache()}get terrain(){return this.game.terrain}resize(){this.canvas&&(this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.terrain&&(this.screenPos=[.5*(this.width-this.terrain.w*this.tileSize),.5*(this.height-this.terrain.h*this.tileSize)]),this.canvas.getContext("2d").imageSmoothingEnabled=!1)}update(t){let e=this.anim;this.anim=[],e=e.filter(e=>e.update(t)),this.anim=this.anim.concat(e),this.animQueue.length>0&&!this.animQueue[0].update(t)&&this.animQueue.shift(),0==this.animQueue.length&&this.blockingAnimationEnd&&(this.blockingAnimationEnd(),delete this.blockingAnimationEnd),this.dolls=this.dolls.filter(t=>t.unit.alive)}render(t){if(!t)return;t.clearRect(0,0,this.width,this.height);let e=this.terrain;t.save(),t.translate(...this.screenPos),this.canvasCache&&!this.canvasCacheOutdated||this.updateCanvasCache(),t.clearRect(0,0,e.w*this.tileSize,e.h*this.tileSize),t.drawImage(this.canvasCache,0,0);for(let e of this.dolls)this.renderDoll(t,e);for(let e of this.anim)e.render&&e.render(t);return this.animQueue.length>0&&this.animQueue[0].render&&this.animQueue[0].render(t),this.busy||this.renderPath(t,this.game.hovered),t.restore(),this.animQueue.length>0}renderPath(t,e){let i=this.game.chosen;if(!(i&&e&&i.dists&&i.dists[e.cid]&&-1!=i.dists[e.cid][1]))return;if(!i.reachable(e))return;let s=this.cidToCenterPoint(e.cid);t.beginPath(),i.reachable(e)?t.arc(s[0],s[1],this.tileSize/4,0,2*Math.PI):(t.moveTo(s[0]-this.tileSize/4,s[1]-this.tileSize/4),t.lineTo(s[0]+this.tileSize/4,s[1]+this.tileSize/4),t.stroke(),t.beginPath(),t.moveTo(s[0]-this.tileSize/4,s[1]+this.tileSize/4),t.lineTo(s[0]+this.tileSize/4,s[1]-this.tileSize/4)),t.stroke();let n=i.pathTo(e);t.beginPath(),t.moveTo(...this.cidToCenterPoint(n[0].cid));for(let e of n)t.lineTo(...this.cidToCenterPoint(e.cid));t.stroke()}renderThreats(t,e){let i=this.terrain,s=e.cid;i.teams[g.RED].strength&&(t.strokeStyle="#800",t.lineWidth=4==i.teams[g.RED].strength[s]?3:1,t.beginPath(),t.moveTo(3.5,3.5),t.lineTo(3.5,3.5+3*i.teams[g.RED].strength[s]),t.stroke(),t.strokeStyle="#008",t.lineWidth=4==i.teams[g.RED].weakness[s]?3:1,t.beginPath(),t.moveTo(3.5,3.5),t.lineTo(3.5+3*i.teams[g.RED].weakness[s],3.5),t.stroke())}renderCell(t,e){let i=this.cidToPoint(e.cid),s=[,this.lowTile,this.highTile][e.obstacle];e.hole&&(s=this.waterTile),s&&t.drawImage(s,i[0],i[1]),e.goody&&(t.translate(...i),t.fillStyle="#080",t.fillRect(.35*this.tileSize,0,.3*this.tileSize,this.tileSize),t.fillRect(0,.35*this.tileSize,this.tileSize,.3*this.tileSize),t.translate(...c(i,-1)))}renderCellUI(t,e){let i=this.cidToPoint(e.cid),s=this.game;if(t.strokeStyle="#000",t.lineWidth=2,s.hovered&&!s.hovered.opaque){let n=s.hovered.xfov.has(e.cid);s.hovered.rfov.has(e.cid)||(t.fillStyle=`rgba(${n?"50,50,0,0.04":"0,0,50,0.1"})`,t.fillRect(i[0],i[1],this.tileSize,this.tileSize))}if(s.chosen&&s.chosen.dists&&!this.busy){let n=s.chosen.apCost(e);if(n>0&&n<=s.chosen.ap){let e=[,this.ap1Sprite,this.ap2Sprite][Math.floor(n)];e&&t.drawImage(e,i[0],i[1])}}e.povs&&e.peeked.includes(this.game.hovered)&&(t.strokeStyle="rgba(0,0,0,0.5)",t.lineWidth=.5,t.beginPath(),t.arc(i[0]+this.tileSize/2,i[1]+this.tileSize/2,this.tileSize/4,0,2*Math.PI),t.stroke())}renderDoll(t,e){t.save(),t.translate(...e.at),this.useDollCache(t,e),e.unit==this.game.chosen?this.outline(t,e,Math.sin((new Date).getTime()/100)+1):e.unit==this.game.hoveredChar&&this.outline(t,e,1.5),t.restore()}outline(t,e,i=2){t.save(),t.strokeStyle=e.unit.strokeColor,t.lineWidth=i,t.beginPath(),t.arc(this.tileSize/2,this.tileSize/2,.4*this.tileSize,0,2*Math.PI),t.stroke(),t.restore()}useDollCache(t,e){let i=e.unit,n=["cid","hp","ap","kind","faction"].map(t=>i[t]);n.push(this.dollTint(e));let a=n.join(",");a in this.dollCache||(this.dollCache[a]=s([this.tileSize,this.tileSize],t=>this.renderDollBody(t,e,this.dollTint(e)))),t.drawImage(this.dollCache[a],0,0)}dollTint(t){if(this.busy||this.terrain.aiTurn)return 0;let e=t.unit,i=0,s=this.game.hovered;if(s&&!s.opaque&&s.xfov){i=s.xfov.has(e.cid)||e.team==this.game.lastSelectedFaction?(0==this.terrain.cover(e.cell,s)?1:0)+(0==this.terrain.cover(s,e.cell)?2:0):4}return this.game.hovered||(i=0),i}renderDollBody(t,e,i){let s=e.unit;t.fillStyle=["#fff","#fba","#cfa","#ffa","#ccc"][i],t.strokeStyle=s.strokeColor,t.shadowColor="#444",t.shadowOffsetX=1,t.shadowOffsetY=1,t.shadowBlur=4,t.beginPath(),t.arc(.5*this.tileSize,.5*this.tileSize,.4*this.tileSize,0,2*Math.PI),t.fill(),t.shadowColor="rgba(0,0,0,0)",t.lineWidth=2;for(let e=0;e<s.hp;e++){let i=Math.PI*(1-e/(s.maxHP-1)),a=(n=i,[Math.cos(n),Math.sin(n)]);t.beginPath(),t.moveTo((.5+.4*a[0])*this.tileSize,(.5+.4*a[1])*this.tileSize),t.lineTo((.5+.5*a[0])*this.tileSize,(.5+.5*a[1])*this.tileSize),t.stroke()}var n;t.lineWidth=1,t.fillStyle=s.strokeColor,t.textAlign="center",t.font=`bold ${this.tileSize/2}pt Courier`,t.fillText(s.symbol.toUpperCase(),.5*this.tileSize,.66*this.tileSize),t.stroke(),s.ap>0&&(t.fillStyle=e.unit.strokeColor,t.beginPath(),t.moveTo(1,1),t.lineTo(6,1),t.lineTo(1,6),t.closePath(),t.fill(),s.ap>1&&(t.beginPath(),t.moveTo(this.tileSize-1,1),t.lineTo(this.tileSize-6,1),t.lineTo(+this.tileSize-1,6),t.closePath(),t.fill()))}cidToPoint(t){return this.terrain.fromCid(t).map(t=>t*this.tileSize)}cidToCenterPoint(t){return c(r(this.terrain.fromCid(t),[.5,.5]),this.tileSize)}cidToCenterScreen(t){return r(this.cidToCenterPoint(t),this.screenPos)}cidFromPoint(t,e){return this.terrain.safeCid(n(t,this.tileSize),n(e,this.tileSize))}cellAtScreenPos(t,e){return this.terrain.cells[this.cidFromPoint(...o([t,e],this.screenPos))]}get animationSpeed(){return this.terrain.aiTurn,.5}updateCanvasCache(){this.canvasCache||(this.canvasCache=i(this.terrain.w*this.tileSize,this.terrain.h*this.tileSize)),this.canvasTerrain||(this.canvasTerrain=i(this.terrain.w*this.tileSize,this.terrain.h*this.tileSize));let t=this.canvasTerrain.getContext("2d");t.clearRect(0,0,this.terrain.w*this.tileSize,this.terrain.h*this.tileSize);for(let e=0;e<this.terrain.cells.length;e++){let i=this.terrain.cells[e];this.renderCell(t,i)}let e=this.canvasCache.getContext("2d");e.clearRect(0,0,this.terrain.w*this.tileSize,this.terrain.h*this.tileSize),e.save(),e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=1,e.shadowColor="#444",e.drawImage(this.canvasTerrain,0,0),e.restore();for(let t=0;t<this.terrain.cells.length;t++){let i=this.terrain.cells[t];this.renderCellUI(e,i)}this.canvasCacheOutdated=!1}resetCanvasCache(){this.canvasCacheOutdated=!0}text(t,e){let i=r(t,[0,-10]);this.anim.push(new S(e,"#f00",3,i,[0,-10]))}renderBullet(t,[e,i],s){t.beginPath();let n=function(t,e=1){let i=l(t)||1;return[t[0]/i*e,t[1]/i*e]}(o(i,e),-20),a=d(e,i,s),h=r(a,n);var c=t.createLinearGradient(h[0],h[1],a[0],a[1]);c.addColorStop(0,"rgba(0,0,0,0)"),c.addColorStop(1,"rgba(0,0,0,1)"),t.lineWidth=4,t.strokeStyle=c,t.moveTo(...h),t.lineTo(...a),t.stroke(),t.lineWidth=1,t.strokeStyle="#000"}shoot(t,e,i){let s,n,a,r=[t,e].map(t=>this.terrain.cells[t]);t:for(n of r[0].povs)for(a of r[1].povs)if(n.rfov.has(a.cid)){s=[n,a].map(t=>this.cidToCenterPoint(t.cid));break t}let l=this.dollAt(t),c=this.dollAt(e),u=0;n.cid==t&&a.cid==e&&(u=1),this.animQueue.push({update:n=>{if(u<1||u>2){let i=.6*(u<1?u:3-u);for(let n=0;n<2;n++){[l,c][n].at=d(this.cidToPoint([t,e][n]),o(s[n],[this.tileSize/2,this.tileSize/2]),i)}u+=n*this.animationSpeed*10}else u+=n*Math.min(10,1e3/h(...s)*this.animationSpeed);return!(u>3)||(this.text(s[1],i>0?`-${i}`:"MISS"),l.at=this.cidToPoint(l.unit.cid),c.at=this.cidToPoint(c.unit.cid),!1)},render:t=>{u>1&&u<2&&this.renderBullet(t,s,u-1)}})}walk(t,e){let i=e.map(t=>this.cidToPoint(t.cid)),s=0;this.animQueue.push({update:e=>(s+=15*e*this.animationSpeed,i[Math.floor(s)+1]?(t.at=d(i[Math.floor(s)],i[Math.floor(s)+1],s-Math.floor(s)),!0):(t.at=i[i.length-1],!1))})}dollOf(t){return this.dolls.find(e=>e.unit==t)}dollAt(t){return this.dolls.find(e=>e.unit.cid==t)}draw(t){return a(this,void 0,void 0,function*(){switch(t.anim){case"walk":this.walk(this.dollOf(t.char),t.path);break;case"shoot":this.shoot(t.from,t.to,t.damage)}yield this.waitForAnim()})}waitForAnim(){return new Promise(t=>{this.blockingAnimationEnd=(()=>t())})}get busy(){return this.animQueue.length>0}initSprites(){this.ap1Sprite=s([this.tileSize,this.tileSize],t=>{t.strokeStyle="#555",t.strokeRect(4.5,4.5,this.tileSize-8,this.tileSize-8)}),this.ap2Sprite=s([this.tileSize,this.tileSize],t=>{t.strokeStyle="#bbb",t.strokeRect(4.5,4.5,this.tileSize-8,this.tileSize-8)}),this.hiddenSprite=s([this.tileSize,this.tileSize],t=>{t.fillStyle="rgba(0,0,0,0.12)",t.fillRect(0,0,this.tileSize,this.tileSize)}),this.dashPattern=s([b,b],t=>{for(let e=0;e<b;e++)t.fillRect(e,e,1,1)}),this.wavePattern=s([8,8],t=>{t.beginPath(),t.arc(4.5,2,5,0,Math.PI),t.stroke()}),this.crossPattern=s([3,3],t=>{for(let e=0;e<b;e++)t.fillRect(b-e-1,e,1,1),t.fillRect(e,e,1,1)}),this.highTile=s([this.tileSize,this.tileSize],t=>{t.fillStyle="#000",t.fillRect(0,0,this.tileSize,this.tileSize)}),this.lowTile=s([this.tileSize,this.tileSize],t=>{t.fillStyle="#fff",t.fillRect(0,0,this.tileSize,this.tileSize),t.fillStyle=t.createPattern(this.dashPattern,"repeat"),t.fillRect(0,0,this.tileSize,this.tileSize)}),this.waterTile=s([this.tileSize,this.tileSize],t=>{t.fillStyle=t.createPattern(this.wavePattern,"repeat"),t.fillRect(0,0,this.tileSize,this.tileSize)})}}let w={name:"Default Campaign",version:"0.1",author:"Baturinsky, Red Knight",startingStage:"Red Knight's Backyard",guns:{carbine:{name:"Carbine",damage:[4,5],damagePenaltyPerCell:100,accuracyPenaltyMax:20,accuracy:60,accuracyOptimalRange:[1,1],accuracyPenaltyPerCell:1,damagePenaltyMax:2,breach:0},sniper:{name:"Sniper",damageOptimalRange:[1,30],damagePenaltyPerCell:.1,accuracyOptimalRange:[10,30],accuracyPenaltyPerCell:1,breach:1,aggression:-.1},shotgun:{name:"Shotgun",damage:[6,7],damageOptimalRange:[1,1],damagePenaltyMax:4,damagePenaltyPerCell:.3,accuracy:80,accuracyOptimalRange:[1,1],accuracyPenaltyPerCell:5,accuracyPenaltyMax:40,aggression:.1}},units:{g:{name:"Gunner",speed:4,maxHP:14,gun:"carbine"},a:{name:"Assault",speed:6,armor:1,gun:"shotgun"},s:{name:"Sharpshooter",maxHP:7,def:10,gun:"sniper"}},stages:[{name:"Backyard 13",version:"1",author:"baturinsky",terrain:"\n    ##################################################\n    #      #  a      ++++# + #    ++#  s             #\n    # #    #  +         +#   #    ++#  ++++++++      #\n    #      +  +         +#   #    ++#  ++++++++      #\n    #S#    +  +         +# * #      #                #\n    #      #  +          #   #      #                #\n    # #    #             #   #      #                #\n    #      #  +          ##a## ######                #\n    #             *                                  #\n    #                                                #\n    #A#    #             #s         #a     ~~~       #\n    #      #  +          #          #    ~~~~~~      #\n    #A#    #  #      #a  #  ###    ++   ~~~#A#~~~    #\n    #      #  #      #   #  #      ++       * ~~~    #\n    #G#    #  ########   #  #      +#    ~ # #~~     #\n    #      #             #          #    ~~~~~~~     #\n    # #    ######  ###########  #####      ~~~~      #\n    #      #++++      ++ # +        #                #\n    #S#    #+            # +   ++   +                #\n    #      #            +#          #                #\n    #         ######g    #       +  #                #\n    #         ######g    #####  #####                #\n    #                    #   g      #      #        +#\n    #      #          +  #                         ++#\n    #G#    #+    *       #+++    +++#   #     #    ++#\n    #      #++      +    #          #g               #\n    # #    ######++###########++##########    ########\n    #                 S+                             #\n    #         +              A+                      #\n    ##################################################\n    "},{name:"Red Knight's Backyard",version:"1",author:"Red Knight",terrain:"\n    ##################################################\n    ################# g+         ###++    ##      ++##\n    ################# ++         +                 +##\n    ####################               a+          +##\n    #################                   +    +      ##\n    #################* #          ++++      ##      ##\n    ####################                     +      ##\n    #################        +# + #+a##     g#   ++g##\n    ##################+##  ####################  +####\n    ###   +++  #*+  # g#   a###################      #\n    ###       a#   +# +#    ##########+#++++  #   # *#\n    #   +      ###  #  #    #        # a+++   #   ####\n    #  g+        #  #+ #       +  +  #              ##\n    #   +        ## ## #      g+  +     +           ##\n    #                  #  g #        #+  +++  #     ##\n    #    + ## ####  #     ++#  +  +  #a  +#+  #     ##\n    #    + g# +###  ####    #######  ##########     ##\n    #++  + ## ##a+  +  #   +##+a+     + #  +  ##+   ##\n    #       # +#       #++ +# + +   +g+ # ++ +#+    ##\n    #       # +#   +   #+         +++               ##\n    #   #++## +## #+# ##            +               ##\n    #   +         +         #         ++      #     ##\n    #                  #    # ####### ### ## ### +  ##\n    #   #  a+          #g   # a*##++a     #+  #  +  ##\n    #~~~~~~~~~ ~~~~~~####  ###########++######## +  ##\n    #~~~~~~~~# #~~~~~~##    a+#+ +                  ##\n    #~~~~~~~~ *              +     # ##         SAGA##\n    ###~~~~~~# #~~~~~~~~           #  #         SGGA##\n    ####~~~~~~~~~~~~~~~#           # *#         SAAA##\n    ##################################################\n    "}]};class x{constructor(t){this.updateUI=t,this.time=0,this.mode=x.PAI,this.momentum=[0,0],this.tooltip=document.getElementById("tooltip"),this.info=document.getElementById("info"),this.renderer=new P(this),this.init()}init(t){let e;if(delete this.chosen,delete this.hovered,delete this.lastSelectedFaction,t&&"string"==typeof t&&(t=JSON.parse(t)),t&&t.customCampaign){this.customCampaign=!0;let i=t.customCampaign.split('"');for(let t=1;t<i.length;t+=2)i[t]=i[t].replace(/\n/g,"\\n");e=JSON.parse(i.join('"'))}e||(e=w),this.terrain=new y(e,t,t=>this.renderer.draw(t)),this.renderer.synch(),console.log(this.serialize())}serialize(){return JSON.stringify({terrain:this.terrain.serialize(),customCampaign:!!this.customCampaign&&this.campaign})}setCanvas(t){this.canvas=t,this.ctx=t.getContext("2d"),this.renderer&&this.renderer.resize()}over(){return!1}update(t){this.lastLoopTimeStamp||(this.lastLoopTimeStamp=t-.001);let e=Math.min(.02,(t-this.lastLoopTimeStamp)/1e3);this.lastLoopTimeStamp=t,this.time+=e,this.renderer.update(e),this.renderer.render(this.ctx),this.over()&&this.updateUI({over:!0}),this.chosen&&!this.chosen.alive&&delete this.chosen}updateTooltip(t,e){this.tooltip.style.display=t?"block":"none",t&&(this.tooltip.style.left=(t[0]+30+this.canvas.offsetLeft).toString(),this.tooltip.style.top=t[1].toString(),this.tooltip.innerHTML=e)}updateInfo(t){this.info.innerHTML=t||(this.terrain.victor?`<H3 style="color:white; background:${this.terrain.victor.color}">${this.terrain.victor.name} side victorious</H3>`:"")}click(t,e){let i=this.renderer.cellAtScreenPos(t,e);this.clickCell(i),this.renderer.resetCanvasCache()}canPlayAs(t){return t.blue||this.mode!=x.PAI}clickCell(t){if(t){if(t.unit){if(this.chosen&&this.chosen.team==t.unit.team&&this.canPlayAs(t.unit))return this.chosen=t.unit,void this.chosen.calculate();if(this.chosen&&this.chosen.canDamage(t.unit))return void this.chosen.shoot(t);this.chosen==t.unit?this.cancel():this.canPlayAs(t.unit)&&(this.chosen=t.unit),this.chosen&&this.chosen.calculate()}!t.unit&&this.chosen&&this.chosen.reachable(t)&&(this.chosen.move(t),this.terrain.teams[g.RED].calculate()),this.lastSelectedFaction=this.chosen?this.chosen.team:this.terrain.we}}cancel(){delete this.chosen,this.renderer.resetCanvasCache()}drag(t,e){this.renderer.screenPos=r(this.renderer.screenPos,[t,e])}hover(t,e){let i=this.renderer.cellAtScreenPos(t,e);if(this.hovered==i)return;if(!i)return delete this.hovered,void this.renderer.resetCanvasCache();if(!i)return;this.hovered=i;let s="default";(this.chosen&&this.chosen.reachable(i)||i.unit)&&(s="pointer"),this.chosen&&this.chosen.canDamage(i.unit)?(s="crosshair",this.updateTooltip(this.renderer.cidToCenterScreen(i.cid),`${this.chosen.hitChance(i.unit)}% ${this.chosen.gun.averageDamage(this.chosen,i.unit).toFixed(1)}`)):this.updateTooltip(),document.body.style.cursor=s,i.unit?this.updateInfo(i.unit.info()):this.updateInfo(),this.renderer.busy||this.renderer.resetCanvasCache()}endTurn(){return a(this,void 0,void 0,function*(){delete this.chosen,this.aiTurn=!0,this.updateUI({aiMoving:!0}),this.mode==x.AIAI&&(yield this.terrain.teams[g.BLUE].aiTurn()),this.terrain.teams[g.RED].beginTurn(),this.mode!=x.PP&&(yield this.terrain.teams[g.RED].aiTurn()),this.terrain.teams[g.BLUE].beginTurn(),this.renderer.resetCanvasCache(),this.aiTurn=!1,this.updateUI({aiMoving:!1})})}toggleMode(){return this.mode=(this.mode+1)%3,["[P+AI] 2P 2AI","P+AI [2P] 2AI","P+AI 2P [2AI]"][this.mode]}setMode(t){this.mode=t}get hoveredChar(){if(this.hovered)return this.hovered.unit}get campaignString(){return JSON.stringify(this.campaign||w,null," ").replace(/\\n/g,"\n")}}x.PAI=0,x.PP=1,x.AIAI=2;var k=function(){},T={},z=[],_=[];function A(t,e){var i,s,n,a,r=_;for(a=arguments.length;a-- >2;)z.push(arguments[a]);for(e&&null!=e.children&&(z.length||z.push(e.children),delete e.children);z.length;)if((s=z.pop())&&void 0!==s.pop)for(a=s.length;a--;)z.push(s[a]);else"boolean"==typeof s&&(s=null),(n="function"!=typeof t)&&(null==s?s="":"number"==typeof s?s=String(s):"string"!=typeof s&&(n=!1)),n&&i?r[r.length-1]+=s:r===_?r=[s]:r.push(s),i=n;var o=new k;return o.nodeName=t,o.children=r,o.attributes=null==e?void 0:e,o.key=null==e?void 0:e.key,o}function M(t,e){for(var i in e)t[i]=e[i];return t}function D(t,e){t&&("function"==typeof t?t(e):t.current=e)}var E="function"==typeof Promise?Promise.resolve().then.bind(Promise.resolve()):setTimeout,R=/acit|ex(?:s|g|n|p|$)|rph|ows|mnc|ntw|ine[ch]|zoo|^ord/i,I=[];function N(t){!t._dirty&&(t._dirty=!0)&&1==I.push(t)&&E(O)}function O(){for(var t;t=I.pop();)t._dirty&&et(t)}function L(t,e){return t.normalizedNodeName===e||t.nodeName.toLowerCase()===e.toLowerCase()}function U(t){var e=M({},t.attributes);e.children=t.children;var i=t.nodeName.defaultProps;if(void 0!==i)for(var s in i)void 0===e[s]&&(e[s]=i[s]);return e}function B(t){var e=t.parentNode;e&&e.removeChild(t)}function H(t,e,i,s,n){if("className"===e&&(e="class"),"key"===e);else if("ref"===e)D(i,null),D(s,t);else if("class"!==e||n)if("style"===e){if(s&&"string"!=typeof s&&"string"!=typeof i||(t.style.cssText=s||""),s&&"object"==typeof s){if("string"!=typeof i)for(var a in i)a in s||(t.style[a]="");for(var a in s)t.style[a]="number"==typeof s[a]&&!1===R.test(a)?s[a]+"px":s[a]}}else if("dangerouslySetInnerHTML"===e)s&&(t.innerHTML=s.__html||"");else if("o"==e[0]&&"n"==e[1]){var r=e!==(e=e.replace(/Capture$/,""));e=e.toLowerCase().substring(2),s?i||t.addEventListener(e,W,r):t.removeEventListener(e,W,r),(t._listeners||(t._listeners={}))[e]=s}else if("list"!==e&&"type"!==e&&!n&&e in t){try{t[e]=null==s?"":s}catch(t){}null!=s&&!1!==s||"spellcheck"==e||t.removeAttribute(e)}else{var o=n&&e!==(e=e.replace(/^xlink:?/,""));null==s||!1===s?o?t.removeAttributeNS("http://www.w3.org/1999/xlink",e.toLowerCase()):t.removeAttribute(e):"function"!=typeof s&&(o?t.setAttributeNS("http://www.w3.org/1999/xlink",e.toLowerCase(),s):t.setAttribute(e,s))}else t.className=s||""}function W(t){return this._listeners[t.type](t)}var F=[],q=0,X=!1,j=!1;function G(){for(var t;t=F.shift();)t.componentDidMount&&t.componentDidMount()}function Q(t,e,i,s,n,a){q++||(X=null!=n&&void 0!==n.ownerSVGElement,j=null!=t&&!("__preactattr_"in t));var r=V(t,e,i,s,a);return n&&r.parentNode!==n&&n.appendChild(r),--q||(j=!1,a||G()),r}function V(t,e,i,s,n){var a=t,r=X;if(null!=e&&"boolean"!=typeof e||(e=""),"string"==typeof e||"number"==typeof e)return t&&void 0!==t.splitText&&t.parentNode&&(!t._component||n)?t.nodeValue!=e&&(t.nodeValue=e):(a=document.createTextNode(e),t&&(t.parentNode&&t.parentNode.replaceChild(a,t),$(t,!0))),a.__preactattr_=!0,a;var o,l,h=e.nodeName;if("function"==typeof h)return function(t,e,i,s){var n=t&&t._component,a=n,r=t,o=n&&t._componentConstructor===e.nodeName,l=o,h=U(e);for(;n&&!l&&(n=n._parentComponent);)l=n.constructor===e.nodeName;n&&l&&(!s||n._component)?(tt(n,h,3,i,s),t=n.base):(a&&!o&&(it(a),t=r=null),n=K(e.nodeName,h,i),t&&!n.nextBase&&(n.nextBase=t,r=null),tt(n,h,1,i,s),t=n.base,r&&t!==r&&(r._component=null,$(r,!1)));return t}(t,e,i,s);if(X="svg"===h||"foreignObject"!==h&&X,h=String(h),(!t||!L(t,h))&&(o=h,(l=X?document.createElementNS("http://www.w3.org/2000/svg",o):document.createElement(o)).normalizedNodeName=o,a=l,t)){for(;t.firstChild;)a.appendChild(t.firstChild);t.parentNode&&t.parentNode.replaceChild(a,t),$(t,!0)}var c=a.firstChild,d=a.__preactattr_,u=e.children;if(null==d){d=a.__preactattr_={};for(var p=a.attributes,m=p.length;m--;)d[p[m].name]=p[m].value}return!j&&u&&1===u.length&&"string"==typeof u[0]&&null!=c&&void 0!==c.splitText&&null==c.nextSibling?c.nodeValue!=u[0]&&(c.nodeValue=u[0]):(u&&u.length||null!=c)&&function(t,e,i,s,n){var a,r,o,l,h,c=t.childNodes,d=[],u={},p=0,m=0,f=c.length,g=0,v=e?e.length:0;if(0!==f)for(var y=0;y<f;y++){var S=c[y],b=S.__preactattr_,C=v&&b?S._component?S._component.__key:b.key:null;null!=C?(p++,u[C]=S):(b||(void 0!==S.splitText?!n||S.nodeValue.trim():n))&&(d[g++]=S)}if(0!==v)for(var y=0;y<v;y++){l=e[y],h=null;var C=l.key;if(null!=C)p&&void 0!==u[C]&&(h=u[C],u[C]=void 0,p--);else if(m<g)for(a=m;a<g;a++)if(void 0!==d[a]&&(P=r=d[a],x=n,"string"==typeof(w=l)||"number"==typeof w?void 0!==P.splitText:"string"==typeof w.nodeName?!P._componentConstructor&&L(P,w.nodeName):x||P._componentConstructor===w.nodeName)){h=r,d[a]=void 0,a===g-1&&g--,a===m&&m++;break}h=V(h,l,i,s),o=c[y],h&&h!==t&&h!==o&&(null==o?t.appendChild(h):h===o.nextSibling?B(o):t.insertBefore(h,o))}var P,w,x;if(p)for(var y in u)void 0!==u[y]&&$(u[y],!1);for(;m<=g;)void 0!==(h=d[g--])&&$(h,!1)}(a,u,i,s,j||null!=d.dangerouslySetInnerHTML),function(t,e,i){var s;for(s in i)e&&null!=e[s]||null==i[s]||H(t,s,i[s],i[s]=void 0,X);for(s in e)"children"===s||"innerHTML"===s||s in i&&e[s]===("value"===s||"checked"===s?t[s]:i[s])||H(t,s,i[s],i[s]=e[s],X)}(a,e.attributes,d),X=r,a}function $(t,e){var i=t._component;i?it(i):(null!=t.__preactattr_&&D(t.__preactattr_.ref,null),!1!==e&&null!=t.__preactattr_||B(t),Y(t))}function Y(t){for(t=t.lastChild;t;){var e=t.previousSibling;$(t,!0),t=e}}var J=[];function K(t,e,i){var s,n=J.length;for(t.prototype&&t.prototype.render?(s=new t(e,i),st.call(s,e,i)):((s=new st(e,i)).constructor=t,s.render=Z);n--;)if(J[n].constructor===t)return s.nextBase=J[n].nextBase,J.splice(n,1),s;return s}function Z(t,e,i){return this.constructor(t,i)}function tt(t,e,i,s,n){t._disable||(t._disable=!0,t.__ref=e.ref,t.__key=e.key,delete e.ref,delete e.key,void 0===t.constructor.getDerivedStateFromProps&&(!t.base||n?t.componentWillMount&&t.componentWillMount():t.componentWillReceiveProps&&t.componentWillReceiveProps(e,s)),s&&s!==t.context&&(t.prevContext||(t.prevContext=t.context),t.context=s),t.prevProps||(t.prevProps=t.props),t.props=e,t._disable=!1,0!==i&&(1!==i&&!1===T.syncComponentUpdates&&t.base?N(t):et(t,1,n)),D(t.__ref,t))}function et(t,e,i,s){if(!t._disable){var n,a,r,o=t.props,l=t.state,h=t.context,c=t.prevProps||o,d=t.prevState||l,u=t.prevContext||h,p=t.base,m=t.nextBase,f=p||m,g=t._component,v=!1,y=u;if(t.constructor.getDerivedStateFromProps&&(l=M(M({},l),t.constructor.getDerivedStateFromProps(o,l)),t.state=l),p&&(t.props=c,t.state=d,t.context=u,2!==e&&t.shouldComponentUpdate&&!1===t.shouldComponentUpdate(o,l,h)?v=!0:t.componentWillUpdate&&t.componentWillUpdate(o,l,h),t.props=o,t.state=l,t.context=h),t.prevProps=t.prevState=t.prevContext=t.nextBase=null,t._dirty=!1,!v){n=t.render(o,l,h),t.getChildContext&&(h=M(M({},h),t.getChildContext())),p&&t.getSnapshotBeforeUpdate&&(y=t.getSnapshotBeforeUpdate(c,d));var S,b,C=n&&n.nodeName;if("function"==typeof C){var P=U(n);(a=g)&&a.constructor===C&&P.key==a.__key?tt(a,P,1,h,!1):(S=a,t._component=a=K(C,P,h),a.nextBase=a.nextBase||m,a._parentComponent=t,tt(a,P,0,h,!1),et(a,1,i,!0)),b=a.base}else r=f,(S=g)&&(r=t._component=null),(f||1===e)&&(r&&(r._component=null),b=Q(r,n,h,i||!p,f&&f.parentNode,!0));if(f&&b!==f&&a!==g){var w=f.parentNode;w&&b!==w&&(w.replaceChild(b,f),S||(f._component=null,$(f,!1)))}if(S&&it(S),t.base=b,b&&!s){for(var x=t,k=t;k=k._parentComponent;)(x=k).base=b;b._component=x,b._componentConstructor=x.constructor}}for(!p||i?F.push(t):v||t.componentDidUpdate&&t.componentDidUpdate(c,d,y);t._renderCallbacks.length;)t._renderCallbacks.pop().call(t);q||s||G()}}function it(t){var e=t.base;t._disable=!0,t.componentWillUnmount&&t.componentWillUnmount(),t.base=null;var i=t._component;i?it(i):e&&(null!=e.__preactattr_&&D(e.__preactattr_.ref,null),t.nextBase=e,B(e),J.push(t),Y(e)),D(t.__ref,null)}function st(t,e){this._dirty=!0,this.context=e,this.props=t,this.state=this.state||{},this._renderCallbacks=[]}function nt(){return A("div",{id:"help"},A("h3",null,"This is a prototype of a browser XCOM-like game."),A("p",null,"Currently it only has three unit types, no complex moves like overwatch, and only one map, but it will grow. It's already fully playable and closely matches XCOM conventions. Left click on your",A("span",{style:"color:blue"},"(blue)"),' units to select, click on empty space to move or on enemy to fire. Right click to deselect. Each unit has two action points (hence the game\'s name), shown as "horns". And some Hit Points, shown as the "beard". Units, naturally, die when out of HP, but can replenish HPs with "*" pickups. When next to cover (black or dashed squares), unit is protected by it on respective side and can "peek" out of it to shoot or, sadly, be shot at, just like in XCOM. Black squares are high cover, granting 40% defence and blocking vision. Dashed squares are low cover, giving only 20$ defence and no LOS obsruction.'),A("p",null,"When you hover the mouse over the square, you can see what is visible from it, and which enemies are flanked from (i.e. have no cover, marked"," ",A("span",{style:"background:#8f8"},"green"),"), or",A("span",{style:"background:#f88"},"flanking")," this square, or",A("span",{style:"background:#ff8;"},"both"),"."),A("p",null,'You can play against AI, it\'s a default mode. AI is quite competent, seeking cover and trying to flank you when possible. Also you can switch to 2 player mode, or even AI vs AI. Difference, basically, is that when you press "End turn", AI will make moves, depending on mode, for none, one or both sides if they have APs remained.'),A("p",null,'Even more, you can play on your own map! Just switch to Edit mode, and edit text field. # is high cover, + is low cover, G, A, S are blue units and g, a, s are red units. Note that map borders should always be high cover. Don\'t forget to press "Apply" when you done.'))}M(st.prototype,{setState:function(t,e){this.prevState||(this.prevState=this.state),this.state=M(M({},this.state),"function"==typeof t?t(this.state,this.props):t),e&&this._renderCallbacks.push(e),N(this)},forceUpdate:function(t){t&&this._renderCallbacks.push(t),et(this,2)},render:function(){}});let at=!1;class rt extends st{constructor(){super(...arguments),this.state={mode:0,page:"play",game:void 0,stageEdit:""},this.canvas={},this.updateUI=(t=>{this.setState(t)})}get game(){return this.state.game}gameUpdated(t){this.setState({game:t})}setMode(t){this.setState({mode:t}),this.game.setMode(t)}setPage(t){if(this.setState({page:t}),"edit"==t&&this.setState({stageEdit:this.game.campaignString}),"save"==t){let t=this.state.game.serialize();localStorage.setItem("2apSave",t),console.log(t),this.setPage("play")}if("load"==t){let t=localStorage["2apSave"];t&&this.game.init(t),this.setPage("play")}}clickDone(){let t=this.state.page;"play"==t&&this.game.endTurn(),"edit"==t&&(this.game.init({customCampaign:this.state.stageEdit}),this.setPage("play"))}componentDidMount(){this.gameUpdated(new x(this.updateUI));let t=this.canvas.current;!function(t,e){let i=0;e.addEventListener("mouseup",t=>{i=0}),e.addEventListener("mousedown",e=>{2==e.button?t.cancel():t.click(e.offsetX,e.offsetY)}),e.addEventListener("mousemove",e=>{6&e.buttons&&++i>=3&&t.drag(e.movementX,e.movementY),t.hover(e.offsetX,e.offsetY)}),e.addEventListener("mouseleave",e=>{t.hover()}),e.addEventListener("mouseenter",t=>{}),e.addEventListener("contextmenu",function(t){t.preventDefault()},!1)}(this.game,t),this.game.setCanvas(t),window.onresize=(()=>{this.game.renderer.resize()}),function t(e){requestAnimationFrame(i=>{e(i),t(e)})}(t=>{!this.game||at||this.game.over()||this.game.update(t)})}displayIfPage(t){return this.state.page==t?"display:flex":"display:none"}topButtons(){return"play"==this.state.page?[["vs AI",()=>this.setMode(0)],["2P",()=>this.setMode(1)],["2AI",()=>this.setMode(2)],[void 0,void 0],["Menu","menu"]]:[["New Game","new"],["Load","load"],["Save","save"],["Settings","settings"],["Editor","edit"],["Help","help"],[void 0,void 0],["Continue","play"]]}render(t,{mode:e,page:i,aiTurn:s}){return A("div",null,A("div",{class:"center-screen"},[A("canvas",{ref:this.canvas,id:"main",style:this.displayIfPage("play")}),A("div",{style:this.displayIfPage("help")},A(nt,null)),A("div",{id:"editor",style:this.displayIfPage("edit")},A("textarea",{onChange:(n=this,a="stageEdit",o=a.split("."),l=n.__lsc||(n.__lsc={}),l[a+r]||(l[a+r]=function(t){for(var e=t&&t.target||this,i={},s=i,a="string"==typeof r?function(t,e,i,s){for(s=0,e=e.split?e.split("."):e;t&&s<e.length;)t=t[e[s++]];return void 0===t?i:t}(t,r):e.nodeName?e.type.match(/^che|rad/)?e.checked:e.value:t,l=0;l<o.length-1;l++)s=s[o[l]]||(s[o[l]]=!l&&n.state[o[l]]||{});s[o[l]]=a,n.setState(i)})),cols:100,rows:40,value:this.state.stageEdit,id:"edit-area"}))]),A("div",{id:"tooltip"}),A("div",{class:"top-buttons row"},this.topButtons().map(([t,s],n)=>t?A("button",{class:("play"==i?"small":"medium")+("play"==i&&e==n||i==s?" pressed":""),onClick:t=>s instanceof Function?s():this.setPage(s)},t):A("span",{class:"flex-spacer"}))),A("div",{class:"bottom-buttons row"},A("div",{id:"info"}),("edit"==i||"play"==i&&!s)&&A("button",{id:"endb",onClick:t=>this.clickDone()},"play"==i?"End Turn":"Apply")));var n,a,r,o,l}}return window.onload=function(){var t,e,i;t=A(rt,null),e=document.body,Q(i,t,{},!1,e,!1)},t.default=(t=>{t.on("@init",()=>({projects:[]})),t.on("projects/add",({projects:t},e)=>({projects:t.concat([e])}))}),t.mouseAt=void 0,t}({});
